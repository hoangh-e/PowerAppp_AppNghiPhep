Screens:
  ProfileScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =//Set active screen first to ensure NavigationComponent receives correct value
        Set(varActiveScreen, "Profile");
        If(Not(varIsUserAuthenticated), 
          Navigate(LoginScreen), 
          If(Not(varIsUserAuthenticated) Or IsBlank(User),
            Navigate(LoginScreen),
            //Continue with screen initialization
            Set(varNavCollapsed, false);
            Set(varMobileMenuOpen, false);
            Set(varCurrentUser, User);
            Set(varEditMode, false);
            Set(varIsSaving, false);
            Set(varSaveSuccess, false);
            Set(varUserDepartment, {
              TenDonVi: "Phòng Công nghệ thông tin",
              MaDonVi: "IT"
            }); 
            Set(varUserRole, {
              TenVaiTro: If(User.MaVaiTro = "ADMIN", "Quản trị viên", If(User.MaVaiTro = "Manager", "Trưởng phòng", "Nhân viên")),
              MaVaiTro: User.MaVaiTro
            }); 
            Set(varUserLeaveBalance, {
              TongNgayDuocPhep: 12,
              SoNgayDaNghi: 3,
              SoNgayConLai: 9,
              Nam: Year(Today())
            }); 
            Set(varUserLeaveHistory, Table(
              {
                ID: "REQ001",
                NgayBatDau: DateAdd(Today(), -30),
                NgayKetThuc: DateAdd(Today(), -28),
                SoNgayNghi: 3,
                TrangThai: "DaDuyet",
                MaLoai: "Annual"
              },
              {
                ID: "REQ002", 
                NgayBatDau: DateAdd(Today(), -15),
                NgayKetThuc: DateAdd(Today(), -13),
                SoNgayNghi: 3,
                TrangThai: "ChoDuyetCap1",
                MaLoai: "Sick"
              }
            )); 
            Set(varProfileErrors, {})
          )
        )
    Children:
      - 'Profile.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =If(IsBlank(User.HoTen), "Đang tải...", User.HoTen)
            UserRole: =If(IsBlank(User.MaVaiTro), "User", User.MaVaiTro)
            ShowNotification: =true
            NotificationCount: =CountRows(Filter(varUserLeaveHistory, TrangThai in ["ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3"]))
            OnLogout: |
              =//Clear all session variables first
              Set(varLoginSuccess, false);
              Set(varSessionValid, false);
              Set(varLoggedInUserEmail, "");
              Set(varIsUserAuthenticated, false);
              //Clear user session object
              Set(UserSession, {
                Id: "", Name: "", Email: "", Role: "", Permission: 0,
                NguoiQuanLyId: "", HoTen: "", MaVaiTro: "", 
                ChucDanh: "", MaDonVi: "", TrangThai: ""
              });
              //Clear current user and profile data
              Set(varCurrentUser, Blank());
              Set(User, Blank());
              Set(varUserLeaveBalance, {});
              Set(varUserLeaveHistory, Table());
              //Set logout flags
              Set(varLocalLoggedOut, true);
              Set(varLocalSessionCleared, true);
              //Navigate to login screen
              Navigate(LoginScreen)
            
      - 'Profile.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='Profile.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.06, App.Width * 0.2)
            Height: =Parent.Height - 'Profile.Header'.Height
            UserRole: =If(IsBlank(User.MaVaiTro), "Employee", User.MaVaiTro)
            ActiveScreen: =If(IsBlank(varActiveScreen), "Profile", varActiveScreen)
            IsCollapsed: =varNavCollapsed
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen),
                "Profile", Navigate(ProfileScreen),
                "LeaveRequest", Navigate(LeaveRequestScreen),
                "MyLeaves", Navigate(MyLeavesScreen),
                "Calendar", Navigate(CalendarScreen),
                "Management", Navigate(ManagementScreen),
                "Approval", Navigate(ApprovalScreen),
                "Reports", Navigate(ReportsScreen)
              )
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)
            
      - 'Profile.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='Profile.Navigation'.Width
            Y: ='Profile.Header'.Height
            Width: =Parent.Width - 'Profile.Navigation'.Width
            Height: =Parent.Height - 'Profile.Header'.Height
          Children:
            # Content Padding Container
            - 'Profile.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.02
                  Y: =Parent.Height * 0.02
                  Width: =Parent.Width * 0.96
                  Height: =Parent.Height * 0.96
                Children:
                  # Profile Header Card
                  - 'Profile.Info.Header':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.25
                      Children:
                        - 'Profile.Info.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(224, 224, 224, 1)
                              BorderThickness: =1
                              
                        # Avatar Section
                        - 'Profile.Avatar.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.04
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.25
                              Height: =Parent.Height * 0.8
                            Children:
                              - 'Profile.Avatar.Circle':
                                  Control: Circle
                                  Properties:
                                    X: =(Parent.Width - Self.Width) / 2
                                    Y: =0
                                    Width: =Parent.Height * 0.7
                                    Height: =Parent.Height * 0.7
                                    Fill: =RGBA(33, 150, 243, 0.1)
                                    BorderColor: =RGBA(33, 150, 243, 1)
                                    BorderThickness: =2
                                    
                              - 'Profile.Avatar.Initial':
                                  Control: Label
                                  Properties:
                                    X: ='Profile.Avatar.Circle'.X + ('Profile.Avatar.Circle'.Width - Self.Width) / 2
                                    Y: ='Profile.Avatar.Circle'.Y + ('Profile.Avatar.Circle'.Height - Self.Height) / 2
                                    Width: ='Profile.Avatar.Circle'.Width * 0.6
                                    Height: ='Profile.Avatar.Circle'.Height * 0.6
                                    Text: =If(IsBlank(User.HoTen), "U", Upper(Left(User.HoTen, 1)))
                                    Color: =RGBA(33, 150, 243, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =Parent.Height * 0.25
                                    Align: =Align.Center
                                    
                              - 'Profile.Avatar.Status':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='Profile.Avatar.Circle'.Y + 'Profile.Avatar.Circle'.Height + Parent.Height * 0.05
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.2
                                    Text: =Switch(If(IsBlank(User.TrangThai), "HoatDong", User.TrangThai),
                                      "HoatDong", "Hoạt động",
                                      "KhongHoatDong", "Không hoạt động",
                                      "TamNghi", "Tạm nghỉ",
                                      "Hoạt động")
                                    Color: =Switch(If(IsBlank(User.TrangThai), "HoatDong", User.TrangThai),
                                      "HoatDong", RGBA(76, 175, 80, 1),
                                      "KhongHoatDong", RGBA(244, 67, 54, 1),
                                      RGBA(255, 152, 0, 1))
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =12
                                    Align: =Align.Center
                                    
                        # Basic Info Section
                        - 'Profile.BasicInfo.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.3
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.45
                              Height: =Parent.Height * 0.8
                            Children:
                              - 'Profile.BasicInfo.Name':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.25
                                    Text: =If(IsBlank(User.HoTen), "Đang tải...", User.HoTen)
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =22
                                    
                              - 'Profile.BasicInfo.ID':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.25
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.2
                                    Text: ="Mã NV:" & " " & If(IsBlank(User.Id), "Đang tải...", User.Id)
                                    Color: =RGBA(107, 114, 128, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =14
                                    
                              - 'Profile.BasicInfo.Role':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.45
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.2
                                    Text: =Switch(If(IsBlank(User.MaVaiTro), "Employee", User.MaVaiTro),
                                      "Employee", "Nhân viên",
                                      "Manager", "Trưởng phòng", 
                                      "ADMIN", "Quản trị viên",
                                      "HR", "Nhân sự",
                                      "Employee")
                                    Color: =RGBA(33, 150, 243, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =16
                                    
                              - 'Profile.BasicInfo.Department':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.65
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.35
                                    Text: =Concatenate(
                                      If(IsBlank(varUserDepartment.TenDonVi), "Phòng Công nghệ thông tin", varUserDepartment.TenDonVi),
                                      Char(10),
                                      "Email:" & " " & If(IsBlank(User.Email), "user@company.com", User.Email)
                                    )
                                    Color: =RGBA(107, 114, 128, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =13
                                    
                        # Edit Profile Button
                        - 'Profile.EditButton':
                            Control: Classic/Button
                            Properties:
                              X: =Parent.Width * 0.77
                              Y: =Parent.Height * 0.15
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.15
                              Text: =If(varEditMode, "Lưu", "Chỉnh sửa")
                              Fill: =If(varEditMode, RGBA(76, 175, 80, 1), RGBA(33, 150, 243, 1))
                              Color: =RGBA(255, 255, 255, 1)
                              BorderColor: =If(varEditMode, RGBA(76, 175, 80, 1), RGBA(33, 150, 243, 1))
                              BorderThickness: =1
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =13
                              OnSelect: |
                                =Set(varEditMode, !varEditMode)
                                
                  # Leave Balance Section
                  - 'Profile.LeaveBalance.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Profile.Info.Header'.Y + 'Profile.Info.Header'.Height + Parent.Height * 0.02
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.18
                      Children:
                        - 'Profile.LeaveBalance.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(224, 224, 224, 1)
                              BorderThickness: =1
                              
                        - 'Profile.LeaveBalance.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.25
                              Text: ="Thông tin ngày phép " & Year(Today())
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =16
                              
                        - 'Profile.LeaveBalance.Stats':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.4
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.5
                            Children:
                              - 'Profile.LeaveBalance.Total':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Tổng phép:" & " " & varUserLeaveBalance.TongNgayDuocPhep & " ngày"
                                    Color: =RGBA(33, 150, 243, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =14
                                    
                              - 'Profile.LeaveBalance.Used':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.35
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Đã dùng:" & " " & varUserLeaveBalance.SoNgayDaNghi & " ngày"
                                    Color: =RGBA(76, 175, 80, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =14
                                    
                              - 'Profile.LeaveBalance.Remaining':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.7
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Còn lại:" & " " & varUserLeaveBalance.SoNgayConLai & " ngày"
                                    Color: =RGBA(255, 152, 0, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =14

            # Detailed Info Tabs
            - 'Profile.Tabs.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='Profile.Info.Header'.Y + 'Profile.Info.Header'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.68
                  Fill: =RGBA(255, 255, 255, 1)
                  BorderColor: =RGBA(230, 230, 230, 1)
                  BorderThickness: =Parent.Width * 0.001
                  DropShadow: =DropShadow.Light
                Children:
                  # Tab Headers
                  - 'Profile.TabHeaders.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.02
                        Y: =Parent.Height * 0.02
                        Width: =Parent.Width * 0.96
                        Height: =Parent.Height * 0.08
                        Fill: =RGBA(248, 249, 250, 1)
                        BorderColor: =RGBA(229, 231, 235, 1)
                        BorderThickness: =Parent.Width * 0.0005
                      Children:
                        - 'Profile.Tab.Personal':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.8
                              Text: ="Thông tin cá nhân"
                              Variant: =If(varSelectedTab = "Personal" Or IsBlank(varSelectedTab), "Primary", "Ghost")
                              Size: ="Small"
                              OnClick: =Set(varSelectedTab, "Personal")
                              
                        - 'Profile.Tab.Leave':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.22
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.8
                              Text: ="Nghỉ phép"
                              Variant: =If(varSelectedTab = "Leave", "Primary", "Ghost")
                              Size: ="Small"
                              OnClick: =Set(varSelectedTab, "Leave")
                              
                        - 'Profile.Tab.Settings':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.42
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.8
                              Text: ="Cài đặt"
                              Variant: =If(varSelectedTab = "Settings", "Primary", "Ghost")
                              Size: ="Small"
                              OnClick: =Set(varSelectedTab, "Settings")
                              
                  # Tab Content
                  - 'Profile.TabContent.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.02
                        Y: ='Profile.TabHeaders.Container'.Y + 'Profile.TabHeaders.Container'.Height + Parent.Height * 0.02
                        Width: =Parent.Width * 0.96
                        Height: =Parent.Height * 0.85
                      Children:
                        # Personal Info Tab
                        - 'Profile.PersonalInfo.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.X
                              Y: =Parent.Y
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Visible: =varSelectedTab = "Personal" Or IsBlank(varSelectedTab)
                            Children:
                              - 'Profile.PersonalInfo.Details':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.02
                                    Width: =Parent.Width * 0.96
                                    Height: =Parent.Height * 0.96
                                    Text: =Concatenate(
                                      "📧 Email:" & " " & varCurrentUser.Email, Char(10), Char(10),
                                      "📞 Số điện thoại:" & " " & If(IsBlank(varCurrentUser.SoDienThoai), "Chưa cập nhật", varCurrentUser.SoDienThoai), Char(10), Char(10),
                                      "💼 Chức danh:" & " " & If(IsBlank(varCurrentUser.ChucDanh), "Chưa cập nhật", varCurrentUser.ChucDanh), Char(10), Char(10),
                                      "🎂 Ngày sinh:" & " " & If(IsBlank(varCurrentUser.NgaySinh), "Chưa cập nhật", Text(varCurrentUser.NgaySinh, "dd/mm/yyyy")), Char(10), Char(10),
                                      "👤 Giới tính:" & " " & If(IsBlank(varCurrentUser.GioiTinh), "Chưa cập nhật", varCurrentUser.GioiTinh), Char(10), Char(10),
                                      "📍 Địa chỉ:" & " " & If(IsBlank(varCurrentUser.DiaChi), "Chưa cập nhật", varCurrentUser.DiaChi), Char(10), Char(10),
                                      "📅 Ngày vào làm:" & " " & If(IsBlank(varCurrentUser.NgayVaoLam), "Chưa cập nhật", Text(varCurrentUser.NgayVaoLam, "dd/mm/yyyy")), Char(10), Char(10),
                                      "📝 Ngày tạo:" & " " & Text(varCurrentUser.NgayTao, "dd/mm/yyyy hh:mm")
                                    )
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =14
                                    
                        # Leave Info Tab
                        - 'Profile.LeaveInfo.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.X
                              Y: =Parent.Y
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Visible: =varSelectedTab = "Leave"
                            Children:
                              - 'Profile.LeaveInfo.Stats':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =Parent.X
                                    Y: =Parent.Y
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.3
                                  Children:
                                    - 'Profile.LeaveStats.Total':
                                        Control: CanvasComponent
                                        ComponentName: StatsCardComponent
                                        Properties:
                                          X: =Parent.X
                                          Y: =Parent.Y
                                          Width: =Parent.Width * 0.32
                                          Height: =Parent.Height
                                          Title: ="Tổng ngày phép"
                                          Value: =If(Not(IsBlank(varUserLeaveBalance)), Text(varUserLeaveBalance.TongNgayDuocPhep), "0")
                                          Icon: ="Calendar"
                                          BackgroundColor: =RGBA(33, 150, 243, 0.1)
                                          IconColor: =RGBA(33, 150, 243, 1)
                                          
                                    - 'Profile.LeaveStats.Used':
                                        Control: CanvasComponent
                                        ComponentName: StatsCardComponent
                                        Properties:
                                          X: =Parent.Width * 0.34
                                          Y: =Parent.Y
                                          Width: =Parent.Width * 0.32
                                          Height: =Parent.Height
                                          Title: ="Đã sử dụng"
                                          Value: =If(Not(IsBlank(varUserLeaveBalance)), Text(varUserLeaveBalance.SoNgayDaNghi), "0")
                                          Icon: ="CheckMark"
                                          BackgroundColor: =RGBA(76, 175, 80, 0.1)
                                          IconColor: =RGBA(76, 175, 80, 1)
                                          
                                    - 'Profile.LeaveStats.Remaining':
                                        Control: CanvasComponent
                                        ComponentName: StatsCardComponent
                                        Properties:
                                          X: =Parent.Width * 0.68
                                          Y: =Parent.Y
                                          Width: =Parent.Width * 0.32
                                          Height: =Parent.Height
                                          Title: ="Còn lại"
                                          Value: =If(Not(IsBlank(varUserLeaveBalance)), Text(varUserLeaveBalance.SoNgayConLai), "0")
                                          Icon: ="Clock"
                                          BackgroundColor: =RGBA(255, 152, 0, 0.1)
                                          IconColor: =RGBA(255, 152, 0, 1)
                                          
                              - 'Profile.LeaveInfo.History':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.35
                                    Width: =Parent.Width * 0.96
                                    Height: =Parent.Height * 0.6
                                    Text: =Concatenate(
                                      "📊 THỐNG KÊ NGHỈ PHÉP NĂM " & Year(Today()), Char(10), Char(10),
                                      "• Tổng đơn đã tạo:" & " " & CountRows(varUserLeaveHistory), Char(10),
                                      "• Đơn chờ duyệt:" & " " & CountRows(Filter(varUserLeaveHistory, TrangThai in ["ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3"])), Char(10),
                                      "• Đơn đã duyệt:" & " " & CountRows(Filter(varUserLeaveHistory, TrangThai = "DaDuyet")), Char(10),
                                      "• Đơn bị từ chối:" & " " & CountRows(Filter(varUserLeaveHistory, TrangThai = "TuChoi")), Char(10), Char(10),
                                      "📈 Đơn gần nhất:", Char(10),
                                      If(CountRows(varUserLeaveHistory) > 0,
                                        With(Last(Sort(varUserLeaveHistory, NgayTao, Descending)),
                                          Concatenate(
                                            "• Ngày:" & " " & Text(NgayBatDau, "dd/mm/yyyy") & " - " & Text(NgayKetThuc, "dd/mm/yyyy"), Char(10),
                                            "• Loại:" & " " & LookUp(LoaiNghi, MaLoai = ThisRecord.MaLoai).TenLoai, Char(10),
                                            "• Trạng thái:" & " " & Switch(TrangThai, "DaDuyet", "Đã duyệt", "TuChoi", "Từ chối", "Chờ duyệt")
                                          )),
                                        "Chưa có đơn nào")
                                    )
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =14
                                    
            # Success/Error Messages
            - 'Profile.Messages.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: =Parent.Height * 0.95
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.03
                  Visible: =varUpdateSuccess Or Not(IsBlank(varProfileErrors))
                Children:
                  - 'Profile.Success.Message':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: =Parent.Y
                        Width: =Parent.Width
                        Height: =Parent.Height
                        Text: ="✅ Cập nhật thông tin thành công!"
                        Color: =RGBA(76, 175, 80, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =14
                        Align: =Align.Center
                        Visible: =varUpdateSuccess
                        
                  - 'Profile.Error.Message':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: =Parent.Y
                        Width: =Parent.Width
                        Height: =Parent.Height
                        Text: ="❌ " & varProfileErrors
                        Color: =RGBA(244, 67, 54, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =14
                        Align: =Align.Center
                        Visible: =Not(IsBlank(varProfileErrors))

                  # Recent Leave History Section
                  - 'Profile.RecentHistory.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Profile.LeaveBalance.Container'.Y + 'Profile.LeaveBalance.Container'.Height + Parent.Height * 0.02
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.53
                      Children:
                        - 'Profile.RecentHistory.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(224, 224, 224, 1)
                              BorderThickness: =1
                              
                        - 'Profile.RecentHistory.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.1
                              Text: ="Lịch sử nghỉ phép gần đây"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =16
                              
                        - 'Profile.RecentHistory.Gallery':
                            Control: Gallery
                            Variant: Vertical
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.18
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.77
                              Items: =varUserLeaveHistory
                              TemplateSize: =Self.Height / 4
                              TemplatePadding: =4
                            Children:
                              - 'HistoryItem.Container':
                                  Control: Rectangle
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.TemplateWidth
                                    Height: =Parent.TemplateHeight - 8
                                    Fill: =Switch(ThisItem.TrangThai, 
                                      "DaDuyet", RGBA(76, 175, 80, 0.1), 
                                      "TuChoi", RGBA(244, 67, 54, 0.1), 
                                      "ChoDuyetCap1", RGBA(255, 193, 7, 0.1),
                                      "ChoDuyetCap2", RGBA(255, 193, 7, 0.1),
                                      "ChoDuyetCap3", RGBA(255, 193, 7, 0.1),
                                      RGBA(248, 250, 252, 1))
                                    BorderColor: =RGBA(224, 224, 224, 1)
                                    BorderThickness: =1
                                    
                              - 'HistoryItem.Date':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.02
                                    Y: =Parent.TemplateHeight * 0.1
                                    Width: =Parent.TemplateWidth * 0.25
                                    Height: =Parent.TemplateHeight * 0.4
                                    Text: =Text(ThisItem.NgayBatDau, "dd/mm/yyyy")
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =11
                                    
                              - 'HistoryItem.Type':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.3
                                    Y: =Parent.TemplateHeight * 0.1
                                    Width: =Parent.TemplateWidth * 0.25
                                    Height: =Parent.TemplateHeight * 0.4
                                    Text: =Switch(ThisItem.MaLoai, "Annual", "Phép năm", "Sick", "Ốm đau", "Personal", "Cá nhân", "Phép năm")
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =11
                                    
                              - 'HistoryItem.Status':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.58
                                    Y: =Parent.TemplateHeight * 0.1
                                    Width: =Parent.TemplateWidth * 0.2
                                    Height: =Parent.TemplateHeight * 0.4
                                    Text: =Switch(ThisItem.TrangThai, 
                                      "DaDuyet", "Đã duyệt", 
                                      "TuChoi", "Từ chối", 
                                      "ChoDuyetCap1", "Chờ duyệt",
                                      "ChoDuyetCap2", "Chờ duyệt", 
                                      "ChoDuyetCap3", "Chờ duyệt",
                                      "Huy", "Đã hủy", 
                                      "Đang xử lý")
                                    Color: =Switch(ThisItem.TrangThai, 
                                      "DaDuyet", RGBA(76, 175, 80, 1), 
                                      "TuChoi", RGBA(244, 67, 54, 1), 
                                      "ChoDuyetCap1", RGBA(255, 152, 0, 1),
                                      "ChoDuyetCap2", RGBA(255, 152, 0, 1),
                                      "ChoDuyetCap3", RGBA(255, 152, 0, 1),
                                      RGBA(107, 114, 128, 1))
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =11
                                    
                              - 'HistoryItem.Days':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.8
                                    Y: =Parent.TemplateHeight * 0.1
                                    Width: =Parent.TemplateWidth * 0.18
                                    Height: =Parent.TemplateHeight * 0.4
                                    Text: =ThisItem.SoNgayNghi & " ngày"
                                    Color: =RGBA(107, 114, 128, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =11
                                    Align: =Align.Center
                                    
                              - 'HistoryItem.Period':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.02
                                    Y: =Parent.TemplateHeight * 0.55
                                    Width: =Parent.TemplateWidth * 0.96
                                    Height: =Parent.TemplateHeight * 0.35
                                    Text: ="Từ " & Text(ThisItem.NgayBatDau, "dd/mm") & " đến " & Text(ThisItem.NgayKetThuc, "dd/mm")
                                    Color: =RGBA(107, 114, 128, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =10
                                    
                        # Quick Actions
                        - 'Profile.QuickActions.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.96
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.02
                              Visible: =false
                            Children:
                              - 'Profile.QuickActions.NewRequest':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Tạo đơn mới"
                                    Variant: ="Primary"
                                    Size: ="Small"
                                    Icon: ="Add"
                                    IconPosition: ="Left"
                                    IsDisabled: =false
                                    IsLoading: =false
                                    LoadingText: ="Đang xử lý..."
                                    FullWidth: =false
                                    OnClick: |
                                      =Navigate(LeaveRequestScreen)
                                      
                              - 'Profile.QuickActions.ViewAll':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.35
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Xem tất cả"
                                    Variant: ="Outline"
                                    Size: ="Small"
                                    Icon: ="View"
                                    IconPosition: ="Left"
                                    IsDisabled: =false
                                    IsLoading: =false
                                    LoadingText: ="Đang xử lý..."
                                    FullWidth: =false
                                    OnClick: |
                                      =Navigate(MyLeavesScreen) 
