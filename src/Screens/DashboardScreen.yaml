Screens:
  DashboardScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =//Set active screen first to ensure NavigationComponent receives correct value
        Set(varActiveScreen, "Dashboard");
        //SESSION VALIDATION: Redirect to login if not authenticated
        If(Not(IsUserAuthenticated) Or IsBlank(User),
          Navigate(LoginScreen),
          //Continue with dashboard initialization only if authenticated
          Set(varNavCollapsed, false); 
          Set(varMobileMenuOpen, false);
          //Initialize demo data for preview (using actual User data when available)
          Set(varDashboardStats, {
            TotalLeave: 12, 
            UsedLeave: 3, 
            RemainingLeave: 9, 
            PendingRequests: 1, 
            ApprovedRequests: 2, 
            RejectedRequests: 0
          }); 
          Set(varPendingApprovalsCount, 0);
          Set(varMyRecentLeaves, Table(
            {
              ID: "REQ001",
              NgayBatDau: DateAdd(Today(), -5), 
              NgayKetThuc: DateAdd(Today(), -4), 
              SoNgayNghi: 2, 
              TrangThai: "DaDuyet",
              MaLoai: "Annual",
              MaNguoiDung: "EMP001"
            },
            {
              ID: "REQ002",
              NgayBatDau: DateAdd(Today(), -10), 
              NgayKetThuc: DateAdd(Today(), -8), 
              SoNgayNghi: 3, 
              TrangThai: "ChoDuyetCap1",
              MaLoai: "Sick",
              MaNguoiDung: "EMP001"
            }
          ));
          //Debug: Set navigation test flag
          Set(varNavigationReady, true)
        )
    Children:
      - 'Dashboard.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =If(IsBlank(User.HoTen), "Đang tải...", User.HoTen)
            UserRole: =If(IsBlank(User.MaVaiTro), "User", User.MaVaiTro)
            ShowNotification: =true
            NotificationCount: =varPendingApprovalsCount
            OnLogout: |
              =//Clear all session variables first
              Set(varLoginSuccess, false);
              Set(varSessionValid, false);
              Set(varLoggedInUserEmail, "");
              Set(IsUserAuthenticated, false);
              //Clear user session object
              Set(UserSession, {
                Id: "", Name: "", Email: "", Role: "", Permission: 0,
                NguoiQuanLyId: "", HoTen: "", MaVaiTro: "", 
                ChucDanh: "", MaDonVi: "", TrangThai: ""
              });
              //Clear current user and dashboard data
              Set(varCurrentUser, Blank());
              Set(User, Blank());
              Set(varDashboardStats, {});
              Set(varMyRecentLeaves, Table());
              //Set logout flags
              Set(varLocalLoggedOut, true);
              Set(varLocalSessionCleared, true);
              //Navigate to login screen
              Navigate(LoginScreen)
            
      - 'Dashboard.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='Dashboard.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.045, App.Width * 0.14)
            Height: =Parent.Height - 'Dashboard.Header'.Height
            UserRole: =If(IsBlank(User.MaVaiTro), "Employee", User.MaVaiTro)
            ActiveScreen: =If(IsBlank(varActiveScreen), "Dashboard", varActiveScreen)
            IsCollapsed: =varNavCollapsed
            DashboardScreen: =DashboardScreen
            LeaveRequestScreen: =LeaveRequestScreen
            MyLeavesScreen: =MyLeavesScreen
            CalendarScreen: =CalendarScreen
            ManagementScreen: =ManagementScreen
            ProfileScreen: =ProfileScreen
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen),
                "LeaveRequest", Navigate(LeaveRequestScreen),
                "MyLeaves", Navigate(MyLeavesScreen),
                "Calendar", Navigate(CalendarScreen),
                "Management", Navigate(ManagementScreen),
                "Profile", Navigate(ProfileScreen),
                "Approval", Navigate(ApprovalScreen),
                "Reports", Navigate(ReportsScreen)
              )
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)
            
      - 'Dashboard.Content.Container':    
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='Dashboard.Navigation'.Width
            Y: ='Dashboard.Header'.Height
            Width: =Parent.Width - 'Dashboard.Navigation'.Width
            Height: =Parent.Height - 'Dashboard.Header'.Height
          Children:
            - 'Dashboard.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.01
                  Y: =Parent.Height * 0.01
                  Width: =Parent.Width * 0.98
                  Height: =Parent.Height * 0.98
                Children:
                  - 'Dashboard.Content.Welcome':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.1
                      Children:
                        - 'Dashboard.Content.Welcome.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        - 'Dashboard.Content.Welcome.Icon':
                            Control: Classic/Icon
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.25
                              Width: =Parent.Height * 0.2
                              Height: =Parent.Height * 0.2
                              Icon: =Icon.DetailList
                              Color: =RGBA(59, 130, 246, 1)
                              
                        - 'Dashboard.Content.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015 + 'Dashboard.Content.Welcome.Icon'.Width + Parent.Width * 0.01
                              Y: =Parent.Height * 0.2
                              Width: =Parent.Width * 0.8
                              Height: =Parent.Height * 0.35
                              Text: ="Chào mừng quay trở lại, " & If(IsBlank(User.HoTen), "Người dùng", User.HoTen)
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =14
                              
                        - 'Dashboard.Content.Subtitle':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015 + 'Dashboard.Content.Welcome.Icon'.Width + Parent.Width * 0.01
                              Y: =Parent.Height * 0.6
                              Width: =Parent.Width * 0.8
                              Height: =Parent.Height * 0.25
                              Text: ="Phòng ban:" & " " & "Phòng Công nghệ thông tin" & " • " & "Chức danh:" & " " & If(IsBlank(User), "Đang tải...", If(IsBlank(User.ChucDanh), "Nhân viên", User.ChucDanh))
                              Color: =RGBA(75, 85, 99, 1)
                              Font: =Font.'Open Sans'
                              Size: =11
            
            - 'Dashboard.Stats.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =0
                  Y: ='Dashboard.Content.Welcome'.Y + 'Dashboard.Content.Welcome'.Height + Parent.Height * 0.015
                  Width: =Parent.Width
                  Height: =Parent.Height * 0.35
                Children:
                  - 'Dashboard.Stats.Background':
                      Control: Rectangle
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height
                        Fill: =RGBA(255, 255, 255, 1)
                        BorderColor: =RGBA(226, 232, 240, 1)
                        BorderThickness: =1
                        
                  - 'Dashboard.Stats.Header':
                      Control: Label
                      Properties:
                        X: =Parent.Width * 0.015
                        Y: =Parent.Height * 0.05
                        Width: =Parent.Width * 0.97
                        Height: =Parent.Height * 0.1
                        Text: ="Tổng quan nghỉ phép"
                        Color: =RGBA(17, 24, 39, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =14
                        
                  - 'Dashboard.Stats.LeaveBalance.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.015
                        Y: =Parent.Height * 0.18
                        Width: =Parent.Width * 0.97
                        Height: =Parent.Height * 0.34
                      Children:
                        - 'Dashboard.Stats.TotalLeave':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =0
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Tổng ngày phép"
                              Value: =varDashboardStats.TotalLeave
                              Icon: ="CalendarBlank"
                              Color: =RGBA(59, 130, 246, 1)
                              ShowTrend: =false
                              
                        - 'Dashboard.Stats.UsedLeave':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =(Parent.Width + Parent.Width * 0.0125) / 3
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Đã sử dụng"
                              Value: =varDashboardStats.UsedLeave
                              Icon: ="CheckBadge"
                              Color: =RGBA(34, 197, 94, 1)
                              ShowTrend: =false
                              
                        - 'Dashboard.Stats.RemainingLeave':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =(Parent.Width + Parent.Width * 0.0125) * 2 / 3
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Còn lại"
                              Value: =varDashboardStats.RemainingLeave
                              Icon: ="Clock"
                              Color: =RGBA(251, 191, 36, 1)
                              ShowTrend: =false
                              
                  - 'Dashboard.Stats.RequestStatus.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.015
                        Y: =Parent.Height * 0.58
                        Width: =Parent.Width * 0.97
                        Height: =Parent.Height * 0.34
                      Children:
                        - 'Dashboard.Stats.PendingRequests':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =0
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Đang chờ duyệt"
                              Value: =varDashboardStats.PendingRequests
                              Icon: ="Calendar"
                              Color: =RGBA(251, 191, 36, 1)
                              ShowTrend: =false
                              
                        - 'Dashboard.Stats.ApprovedRequests':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =(Parent.Width + Parent.Width * 0.0125) / 3
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Đã được duyệt"
                              Value: =varDashboardStats.ApprovedRequests
                              Icon: ="CheckBadge"
                              Color: =RGBA(34, 197, 94, 1)
                              ShowTrend: =false
                              
                        - 'Dashboard.Stats.RejectedRequests':
                            Control: CanvasComponent
                            ComponentName: StatsCardComponent
                            Properties:
                              X: =(Parent.Width + Parent.Width * 0.0125) * 2 / 3
                              Y: =0
                              Width: =(Parent.Width - Parent.Width * 0.025) / 3
                              Height: =Parent.Height
                              Title: ="Bị từ chối"
                              Value: =varDashboardStats.RejectedRequests
                              Icon: ="Cancel"
                              Color: =RGBA(239, 68, 68, 1)
                              ShowTrend: =false
            
            - 'Dashboard.Activity.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =0
                  Y: ='Dashboard.Stats.Container'.Y + 'Dashboard.Stats.Container'.Height + Parent.Height * 0.015
                  Width: =Parent.Width
                  Height: =Parent.Height * 0.44
                Children:
                  - 'Dashboard.Activity.Background':
                      Control: Rectangle
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height
                        Fill: =RGBA(255, 255, 255, 1)
                        BorderColor: =RGBA(226, 232, 240, 1)
                        BorderThickness: =1
                        
                  - 'Dashboard.Activity.Header.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.015
                        Y: =Parent.Height * 0.03
                        Width: =Parent.Width * 0.97
                        Height: =Parent.Height * 0.12
                      Children:
                        - 'Dashboard.Activity.Title':
                            Control: Label
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width * 0.7
                              Height: =Parent.Height
                              Text: ="Hoạt động gần đây"
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =14
                              
                        - 'Dashboard.Activity.ViewAll':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.6
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.55
                              Text: ="Xem tất cả"
                              Variant: ="Outline"
                              Size: ="Small"
                              OnClick: |
                                =Navigate(MyLeavesScreen)
                              
                        # Debug navigation button
                        - 'Dashboard.Activity.TestNav':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.8
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.55
                              Text: ="Test Nav"
                              Variant: ="Secondary"
                              Size: ="Small"
                              OnClick: |
                                =Set(varActiveScreen, "MyLeaves");
                                Navigate(MyLeavesScreen)
                              
                  - 'Dashboard.Activity.Gallery':
                      Control: Gallery
                      Variant: Vertical
                      Properties:
                        X: =Parent.Width * 0.015
                        Y: =Parent.Height * 0.18
                        Width: =Parent.Width * 0.97
                        Height: =Parent.Height * 0.79
                        Items: =varMyRecentLeaves
                        TemplateSize: =Self.Height / 3.5
                      Children:
                        - 'Gallery.Item.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.TemplateWidth
                              Height: =Parent.TemplateHeight * 0.94
                              Fill: =RGBA(249, 250, 251, 1)
                              BorderColor: =RGBA(229, 231, 235, 1)
                              BorderThickness: =1
                              
                        - 'Gallery.Item.StatusBar':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =2
                              Height: =Parent.TemplateHeight * 0.94
                              Fill: =Switch(ThisItem.TrangThai,
                                "DaDuyet", RGBA(34, 197, 94, 1),
                                "ChoDuyetCap1", RGBA(251, 191, 36, 1),
                                "TuChoi", RGBA(239, 68, 68, 1),
                                RGBA(156, 163, 175, 1))
                              BorderColor: =RGBA(255, 255, 255, 0)
                              BorderThickness: =0
                              
                        - 'Gallery.Item.Content':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =6
                              Y: =Parent.TemplateHeight * 0.06
                              Width: =Parent.TemplateWidth - 12
                              Height: =Parent.TemplateHeight * 0.82
                            Children:
                              - 'Gallery.Item.DateIcon':
                                  Control: Classic/Icon
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Height * 0.25
                                    Height: =Parent.Height * 0.25
                                    Icon: =Icon.CalendarBlank
                                    Color: =RGBA(75, 85, 99, 1)
                                    
                              - 'Gallery.Item.DateRange':
                                  Control: Label
                                  Properties:
                                    X: ='Gallery.Item.DateIcon'.Width + Parent.Width * 0.02
                                    Y: =0
                                    Width: =Parent.Width * 0.5
                                    Height: =Parent.Height * 0.45
                                    Text: =Text(ThisItem.NgayBatDau, "dd/mm/yyyy") & " - " & Text(ThisItem.NgayKetThuc, "dd/mm/yyyy")
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =10
                                    
                              - 'Gallery.Item.Days':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.65
                                    Y: =0
                                    Width: =Parent.Width * 0.35
                                    Height: =Parent.Height * 0.45
                                    Text: =Text(ThisItem.SoNgayNghi) & " ngày"
                                    Color: =RGBA(59, 130, 246, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =10
                                    Align: =Align.Right
                                    
                              - 'Gallery.Item.Status':
                                  Control: Label
                                  Properties:
                                    X: ='Gallery.Item.DateIcon'.Width + Parent.Width * 0.02
                                    Y: =Parent.Height * 0.5
                                    Width: =Parent.Width * 0.65
                                    Height: =Parent.Height * 0.45
                                    Text: =Switch(ThisItem.TrangThai,
                                      "DaDuyet", "Đã được duyệt",
                                      "ChoDuyetCap1", "Đang chờ duyệt",
                                      "TuChoi", "Bị từ chối",
                                      "Không xác định")
                                    Color: =Switch(ThisItem.TrangThai,
                                      "DaDuyet", RGBA(21, 128, 61, 1),
                                      "ChoDuyetCap1", RGBA(180, 83, 9, 1),
                                      "TuChoi", RGBA(220, 38, 38, 1),
                                      RGBA(107, 114, 128, 1))
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Normal
                                    Size: =9

