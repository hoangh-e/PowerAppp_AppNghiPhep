Screens:
  ReportsScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =Set(varActiveScreen, "Reports"); 
        //Permission checks using helper functions from App/Formulas
        Set(varUserPermissions, {
          CanViewDashboard: CheckPermission(UserSessionANP.Permission, UserPermissions.VIEW_DASHBOARD),
          CanViewAllLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.VIEW_ALL_LEAVE),
          CanViewTeamLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.VIEW_TEAM_LEAVE),
          CanExportReports: CheckPermission(UserSessionANP.Permission, UserPermissions.EXPORT_REPORTS),
          CanManageUsers: CheckPermission(UserSessionANP.Permission, UserPermissions.MANAGE_USERS),
          IsSystemAdmin: CheckPermission(UserSessionANP.Permission, UserPermissions.SYSTEM_ADMIN)
        });
        
        //CRITICAL: Check if user can access reports - Admin should always have access
        Set(varCanAccessReports, true);
        Set(varReportType, "Monthly"); 
        Set(varReportPeriod, "This Year"); 
        Set(varSelectedDepartment, UserSessionANP.MaDonVi); 
        Set(varSelectedYear, Year(Today())); 
        Set(varReportData, Table(
          {Thang: 1, TenThang: "Tháng 1", SoDon: 8, SoDonDuyet: 6, SoDonTuChoi: 1, TongNgayNghi: 18},
          {Thang: 2, TenThang: "Tháng 2", SoDon: 5, SoDonDuyet: 4, SoDonTuChoi: 1, TongNgayNghi: 12},
          {Thang: 3, TenThang: "Tháng 3", SoDon: 12, SoDonDuyet: 10, SoDonTuChoi: 2, TongNgayNghi: 30},
          {Thang: 4, TenThang: "Tháng 4", SoDon: 7, SoDonDuyet: 5, SoDonTuChoi: 1, TongNgayNghi: 15},
          {Thang: 5, TenThang: "Tháng 5", SoDon: 3, SoDonDuyet: 3, SoDonTuChoi: 0, TongNgayNghi: 9},
          {Thang: 6, TenThang: "Tháng 6", SoDon: 6, SoDonDuyet: 4, SoDonTuChoi: 1, TongNgayNghi: 12}
        )); 
        Set(varIsGenerating, false); 
        Set(varShowExportOptions, false); 
        Set(varChartType, "Column"); 
        If(varCanAccessReports, 
          //Load SharePoint data with permission-based filtering
          Set(varReportStats, 
            If(IsUserAuthenticated,
              //Admin/HR can see all data, others see filtered data
              If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                //Admin/HR - All company data
                {
                  TotalRequests: CountRows(DonNghiPhep), 
                  ApprovedRequests: CountRows(Filter(DonNghiPhep, TrangThai.Value = "DaDuyet")), 
                  PendingRequests: CountRows(Filter(DonNghiPhep, Or(TrangThai.Value = "ChoDuyetCap1", TrangThai.Value = "ChoDuyetCap2", TrangThai.Value = "ChoDuyetCap3"))), 
                  RejectedRequests: CountRows(Filter(DonNghiPhep, TrangThai.Value = "TuChoi")),
                  CancelledRequests: CountRows(Filter(DonNghiPhep, TrangThai.Value = "Huy")),
                  ExpiredRequests: CountRows(Filter(DonNghiPhep, TrangThai.Value = "HetHan"))
                },
                //Manager - Team data only
                If(varUserPermissions.CanViewTeamLeaves,
                  With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                    {
                      TotalRequests: CountRows(Filter(DonNghiPhep, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"))), 
                      ApprovedRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet"))), 
                      PendingRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), Or(TrangThai.Value = "ChoDuyetCap1", TrangThai.Value = "ChoDuyetCap2", TrangThai.Value = "ChoDuyetCap3")))), 
                      RejectedRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "TuChoi"))),
                      CancelledRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "Huy"))),
                      ExpiredRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "HetHan")))
                    }
                  ),
                  //Employee - Personal data only
                  {
                    TotalRequests: CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = UserSessionANP.Id)), 
                    ApprovedRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet"))), 
                    PendingRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = UserSessionANP.Id, Or(TrangThai.Value = "ChoDuyetCap1", TrangThai.Value = "ChoDuyetCap2", TrangThai.Value = "ChoDuyetCap3")))), 
                    RejectedRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "TuChoi"))),
                    CancelledRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "Huy"))),
                    ExpiredRequests: CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "HetHan")))
                  }
                )
              ),
              //Demo data fallback when not authenticated
              {
                TotalRequests: 45,
                ApprovedRequests: 32,
                PendingRequests: 8,
                RejectedRequests: 5,
                CancelledRequests: 0,
                ExpiredRequests: 0
              }
            )
          ); 
          //Load initial monthly report data from SharePoint with permission filtering
          Set(varReportData, 
            If(IsUserAuthenticated,
              //Permission-based data filtering for monthly reports
              If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                //Admin/HR - All company monthly data
                ForAll(Sequence(12), 
                  With({currentMonth: Value}, {
                    Thang: currentMonth, 
                    TenThang: Switch(currentMonth, 
                      1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 
                      5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 
                      9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                    SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth))),
                    SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet"))), 
                    SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "TuChoi"))),
                    TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                  })
                ),
                //Manager - Team monthly data only
                If(varUserPermissions.CanViewTeamLeaves,
                  With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                    ForAll(Sequence(12), 
                      With({currentMonth: Value}, {
                        Thang: currentMonth, 
                        TenThang: Switch(currentMonth, 
                          1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 
                          5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 
                          9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                        SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title")))),
                        SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet"))), 
                        SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "TuChoi"))),
                        TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet")), SoNgayNghi)
                      })
                    )
                  ),
                  //Employee - Personal monthly data only
                  ForAll(Sequence(12), 
                    With({currentMonth: Value}, {
                      Thang: currentMonth, 
                      TenThang: Switch(currentMonth, 
                        1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 
                        5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 
                        9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                      SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id))),
                      SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet"))), 
                      SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "TuChoi"))),
                      TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                    })
                  )
                )
              ),
              //Demo data fallback when not authenticated
              Table(
                {Thang: 1, TenThang: "Tháng 1", SoDon: 8, SoDonDuyet: 6, SoDonTuChoi: 1, TongNgayNghi: 18},
                {Thang: 2, TenThang: "Tháng 2", SoDon: 5, SoDonDuyet: 4, SoDonTuChoi: 1, TongNgayNghi: 12},
                {Thang: 3, TenThang: "Tháng 3", SoDon: 12, SoDonDuyet: 10, SoDonTuChoi: 2, TongNgayNghi: 30},
                {Thang: 4, TenThang: "Tháng 4", SoDon: 7, SoDonDuyet: 5, SoDonTuChoi: 1, TongNgayNghi: 15},
                {Thang: 5, TenThang: "Tháng 5", SoDon: 3, SoDonDuyet: 3, SoDonTuChoi: 0, TongNgayNghi: 9},
                {Thang: 6, TenThang: "Tháng 6", SoDon: 6, SoDonDuyet: 4, SoDonTuChoi: 1, TongNgayNghi: 12}
              )
            )
          )
        )
    Children:
      - 'Reports.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =UserSessionANP.HoTen
            UserRole: =UserSessionANP.MaVaiTro
            ShowNotification: =true
            NotificationCount: =0
            OnLogout: |
              =Set(varIsUserAuthenticated, false); Set(UserSessionANP, {Id: "", HoTen: "", Email: "", MaVaiTro: "", Permission: 0, NguoiQuanLyId: "", ChucDanh: "", MaDonVi: "", TrangThai: "", Name: "", Role: ""}); Navigate(LoginScreen)

      - 'Reports.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='Reports.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.045, App.Width * 0.14)
            Height: =Parent.Height - 'Reports.Header'.Height
            UserRole: =UserSessionANP.MaVaiTro
            ActiveScreen: ="Reports"
            IsCollapsed: =varNavCollapsed
            DashboardScreen: =DashboardScreen
            LeaveRequestScreen: =LeaveRequestScreen
            MyLeavesScreen: =MyLeavesScreen
            CalendarScreen: =CalendarScreen
            ManagementScreen: =ManagementScreen
            ReportsScreen: =ReportsScreen
            ProfileScreen: =ProfileScreen
            OnNavigate: |
              =Set(varActiveScreen, ScreenName); Switch(ScreenName, "Dashboard", Navigate(DashboardScreen), "LeaveRequest", Navigate(LeaveRequestScreen), "MyLeaves", Navigate(MyLeavesScreen), "Calendar", Navigate(CalendarScreen), "Management", Navigate(ManagementScreen), "Profile", Navigate(ProfileScreen), "Approval", Navigate(ApprovalScreen), "Reports", Navigate(ReportsScreen))
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)

      - 'Reports.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='Reports.Navigation'.Width
            Y: ='Reports.Header'.Height
            Width: =Parent.Width - 'Reports.Navigation'.Width
            Height: =Parent.Height - 'Reports.Header'.Height
            Visible: =varCanAccessReports
          Children:
            - 'Reports.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.015
                  Y: =Parent.Height * 0.015
                  Width: =Parent.Width * 0.97
                  Height: =Parent.Height * 0.97
                Children:
                  - 'Reports.Header.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.25
                      Children:
                        - 'Reports.Header.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        - 'Reports.Header.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.6
                              Height: =Parent.Height * 0.15
                              Text: ="Báo cáo và thống kê"
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =FontSizes.XLarge

                        - 'Reports.Header.Subtitle':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.25
                              Width: =Parent.Width * 0.6
                              Height: =Parent.Height * 0.1
                              Text: =If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                Concatenate("Tổng toàn công ty", ":", " ", Text(varReportStats.TotalRequests), " ", "đơn nghỉ phép"),
                                If(varUserPermissions.CanViewTeamLeaves,
                                  Concatenate("Tổng nhóm của bạn", ":", " ", Text(varReportStats.TotalRequests), " ", "đơn nghỉ phép"),
                                  Concatenate("Tổng cá nhân", ":", " ", Text(varReportStats.TotalRequests), " ", "đơn nghỉ phép")
                                )
                                )
                              Color: =RGBA(107, 114, 128, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Normal
                              Size: =FontSizes.Medium

                        - 'Reports.Export.Button':
                            Control: Export
                            Properties:
                              X: =Parent.Width * 0.75
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.6
                              Text: ="Xuất báo cáo"
                              Data: =varReportData
                              BorderColor: =ColorFade(RGBA(59, 130, 246, 1), -15%)
                              Color: =RGBA(255, 255, 255, 1)
                              Fill: =RGBA(59, 130, 246, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Medium
                              FontWeight: =FontWeight.Semibold
                              HoverBorderColor: =ColorFade(RGBA(59, 130, 246, 1), 20%)
                              HoverColor: =RGBA(255, 255, 255, 1)
                              HoverFill: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                              PressedBorderColor: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                              PressedFill: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                              DisabledFill: =RGBA(156, 163, 175, 1)
                              DisplayMode: =If(CountRows(varReportData) = 0, DisplayMode.Disabled, DisplayMode.Edit)
                              OnSelect: |
                                =Notify(Concatenate("Đã xuất ", Text(CountRows(varReportData)), " bản ghi dữ liệu ", varReportType, " thành file CSV"), NotificationType.Success)

                        - 'Reports.Stats.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.4
                              Width: =Parent.Width * 0.97
                              Height: =Parent.Height * 0.55
                            Children:
                              - 'Reports.Stats.Background':
                                  Control: Rectangle
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height
                                    Fill: =RGBA(249, 250, 251, 1)
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1

                              - 'Reports.Stats.Title':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.05
                                    Width: =Parent.Width * 0.96
                                    Height: =Parent.Height * 0.2
                                    Text: ="Thống kê tổng quan"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Large

                              - 'Reports.Stats.TotalCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.22
                                    Height: =Parent.Height * 0.6
                                    Title: ="Tổng đơn"
                                    Value: =Text(varReportStats.TotalRequests)
                                    Icon: ="DocumentText"
                                    Color: =RGBA(59, 130, 246, 1)

                              - 'Reports.Stats.ApprovedCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.26
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.22
                                    Height: =Parent.Height * 0.6
                                    Title: ="Đã duyệt"
                                    Value: =Text(varReportStats.ApprovedRequests)
                                    Icon: ="CheckBadge"
                                    Color: =RGBA(34, 197, 94, 1)

                              - 'Reports.Stats.PendingCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.5
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.22
                                    Height: =Parent.Height * 0.6
                                    Title: ="Chờ duyệt"
                                    Value: =Text(varReportStats.PendingRequests)
                                    Icon: ="Clock"
                                    Color: =RGBA(251, 191, 36, 1)

                              - 'Reports.Stats.RejectedCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.59
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.6
                                    Title: ="Từ chối"
                                    Value: =Text(varReportStats.RejectedRequests)
                                    Icon: ="Cancel"
                                    Color: =RGBA(239, 68, 68, 1)

                              - 'Reports.Stats.CancelledCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.78
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.1
                                    Height: =Parent.Height * 0.6
                                    Title: ="Hủy"
                                    Value: =Text(varReportStats.CancelledRequests)
                                    Icon: ="Blocked"
                                    Color: =RGBA(156, 163, 175, 1)

                              - 'Reports.Stats.ExpiredCard':
                                  Control: CanvasComponent
                                  ComponentName: StatsCardComponent
                                  Properties:
                                    X: =Parent.Width * 0.89
                                    Y: =Parent.Height * 0.3
                                    Width: =Parent.Width * 0.1
                                    Height: =Parent.Height * 0.6
                                    Title: ="Hết hạn"
                                    Value: =Text(varReportStats.ExpiredRequests)
                                    Icon: ="Timer"
                                    Color: =RGBA(107, 114, 128, 1)

                  - 'Reports.Filter.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Reports.Header.Container'.Y + 'Reports.Header.Container'.Height + Parent.Height * 0.015
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.12
                      Children:
                        - 'Reports.Filter.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(249, 250, 251, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1

                        - 'Reports.Filter.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.2
                              Text: ="Bộ lọc báo cáo"
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =FontSizes.Large

                        - 'Reports.Filter.Type.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.3
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.6
                            Children:
                              - 'Reports.Filter.Type.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.3
                                    Text: ="Loại báo cáo" & ":"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base

                              - 'Reports.Filter.Type.Dropdown':
                                  Control: Classic/DropDown
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.35
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.6
                                    Items: =["Monthly", "Department", "Employee", "LeaveType"]
                                    Default: =varReportType
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    OnChange: |
                                      =Set(varReportType, Self.Selected.Value); 
                                      //Generate SharePoint data based on report type and user permissions
                                      Set(varReportData, 
                                        If(IsUserAuthenticated,
                                          Switch(varReportType, 
                                            "Monthly", 
                                            //Monthly report with permission filtering
                                            If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                              //Admin/HR - All company monthly data
                                              ForAll(Sequence(12), 
                                                With({currentMonth: Value}, {
                                                  Thang: currentMonth, 
                                                  TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                                  SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth))),
                                                  SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet"))), 
                                                  SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "TuChoi"))),
                                                  TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                                })
                                              ),
                                              //Manager/Employee - Filtered monthly data
                                              If(varUserPermissions.CanViewTeamLeaves,
                                                With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                                  ForAll(Sequence(12), 
                                                    With({currentMonth: Value}, {
                                                      Thang: currentMonth, 
                                                      TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                                      SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title")))),
                                                      SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet"))), 
                                                      SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "TuChoi"))),
                                                      TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                                    })
                                                  )
                                                ),
                                                ForAll(Sequence(12), 
                                                  With({currentMonth: Value}, {
                                                    Thang: currentMonth, 
                                                    TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                                    SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id))),
                                                    SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet"))), 
                                                    SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "TuChoi"))),
                                                    TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                                  })
                                                )
                                              )
                                            ), 
                                            "Department", 
                                            //Department report - only for Admin/HR
                                            If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                              AddColumns(
                                                ShowColumns(DonVi, "TenDonVi", "Title"),
                                                "TongNhanVien", CountRows(Filter(NguoiDung, MaDonVi.Value = ThisRecord.Title)),
                                                "TongDonNghi", CountRows(Filter(DonNghiPhep, LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title)),
                                                "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(TrangThai.Value = "DaDuyet", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title))),
                                                "DonTuChoi", CountRows(Filter(DonNghiPhep, And(TrangThai.Value = "TuChoi", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title))),
                                                "TongNgayNghi", Sum(Filter(DonNghiPhep, And(TrangThai.Value = "DaDuyet", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title)), SoNgayNghi)
                                              ),
                                              []
                                            ),
                                            "Employee", 
                                            //Employee report with permission filtering
                                            If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                              //Admin/HR - All employees
                                              AddColumns(
                                                ShowColumns(Filter(NguoiDung, TrangThai.Value = "HoatDong"), "HoTen", "Title", "ChucDanh"),
                                                "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                                "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                                "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                                "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                              ),
                                              //Manager - Team members only
                                              If(varUserPermissions.CanViewTeamLeaves,
                                                With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                                  AddColumns(
                                                    ShowColumns(teamMembers, "HoTen", "Title", "ChucDanh"),
                                                    "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                                    "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                                    "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                                    "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                                  )
                                                ),
                                                //Employee - Personal data only
                                                AddColumns(
                                                  ShowColumns(Filter(NguoiDung, Title = UserSessionANP.Id), "HoTen", "Title", "ChucDanh"),
                                                  "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                                  "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                                  "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                                  "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                                )
                                              )
                                            ),
                                            "LeaveType", 
                                            //Leave type report - available for all users
                                            AddColumns(
                                              LoaiNghi,
                                              "SoLanSuDung", 
                                              If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                                CountRows(Filter(DonNghiPhep, MaLoai.Value = ThisRecord.MaLoai)),
                                                If(varUserPermissions.CanViewTeamLeaves,
                                                  With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                                    CountRows(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"))))
                                                  ),
                                                  CountRows(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, MaNguoiDung.Value = UserSessionANP.Id)))
                                                )
                                              ),
                                              "TongNgayNghi", 
                                              If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                                Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet")), SoNgayNghi),
                                                If(varUserPermissions.CanViewTeamLeaves,
                                                  With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                                    Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet", MaNguoiDung.Value in ShowColumns(teamMembers, "Title"))), SoNgayNghi)
                                                  ),
                                                  Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet", MaNguoiDung.Value = UserSessionANP.Id)), SoNgayNghi)
                                                )
                                              )
                                            ),
                                            []
                                          ),
                                          //Demo data fallback
                                          []
                                        )
                                      )

                        - 'Reports.Filter.Period.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.26
                              Y: =Parent.Height * 0.3
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.6
                            Children:
                              - 'Reports.Filter.Period.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.3
                                    Text: =Concatenate("Thời kỳ", ":")
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base
                        
                              - 'Reports.Filter.Period.Dropdown':
                                  Control: Classic/DropDown
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.35
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.6
                                    Items: =["This Month", "Last Month", "This Quarter", "This Year", "Last Year"]
                                    Default: =varReportPeriod
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    OnChange: |
                                      =Set(varReportPeriod, Self.Selected.Value)

                        - 'Reports.Filter.Year.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.5
                              Y: =Parent.Height * 0.3
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.6
                            Children:
                              - 'Reports.Filter.Year.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.3
                                    Text: =Concatenate("Năm", ":")
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base

                              - 'Reports.Filter.Year.Input':
                                  Control: Classic/TextInput
                                  Properties:
                                    X: =0
                                    Y: =Parent.Height * 0.35
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.6
                                    Default: =Text(varSelectedYear)
                                    Format: =TextFormat.Number
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    OnChange: |
                                      =Set(varSelectedYear, Value(Self.Default))

                        - 'Reports.Filter.Generate':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.74
                              Y: =Parent.Height * 0.4
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.5
                              Text: =If(varIsGenerating, "Đang tạo...", "Tạo báo cáo")
                              Size: ="Medium"
                              IsDisabled: =varIsGenerating
                              OnClick: |
                                =Set(varIsGenerating, true); 
                                //Generate SharePoint report data with permission-based filtering
                                Set(varReportData, 
                                  If(IsUserAuthenticated,
                                    Switch(varReportType, 
                                      "Monthly", 
                                      //Monthly report with permission filtering
                                      If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                        //Admin/HR - All company monthly data
                                        ForAll(Sequence(12), 
                                          With({currentMonth: Value}, {
                                            Thang: currentMonth, 
                                            TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                            SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth))),
                                            SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet"))), 
                                            SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "TuChoi"))),
                                            TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                          })
                                        ),
                                        //Manager/Employee - Filtered monthly data
                                        If(varUserPermissions.CanViewTeamLeaves,
                                          With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                            ForAll(Sequence(12), 
                                              With({currentMonth: Value}, {
                                                Thang: currentMonth, 
                                                TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                                SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title")))),
                                                SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet"))), 
                                                SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "TuChoi"))),
                                                TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"), TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                              })
                                            )
                                          ),
                                          ForAll(Sequence(12), 
                                            With({currentMonth: Value}, {
                                              Thang: currentMonth, 
                                              TenThang: Switch(currentMonth, 1, "Tháng 1", 2, "Tháng 2", 3, "Tháng 3", 4, "Tháng 4", 5, "Tháng 5", 6, "Tháng 6", 7, "Tháng 7", 8, "Tháng 8", 9, "Tháng 9", 10, "Tháng 10", 11, "Tháng 11", 12, "Tháng 12"), 
                                              SoDon: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id))),
                                              SoDonDuyet: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet"))), 
                                              SoDonTuChoi: CountRows(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "TuChoi"))),
                                              TongNgayNghi: Sum(Filter(DonNghiPhep, And(Year(NgayBatDau) = varSelectedYear, Month(NgayBatDau) = currentMonth, MaNguoiDung.Value = UserSessionANP.Id, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                            })
                                          )
                                        )
                                      ), 
                                      "Department", 
                                      //Department report - only for Admin/HR
                                      If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                        AddColumns(
                                          ShowColumns(DonVi, "TenDonVi", "Title"),
                                          "TongNhanVien", CountRows(Filter(NguoiDung, MaDonVi.Value = ThisRecord.Title)),
                                          "TongDonNghi", CountRows(Filter(DonNghiPhep, LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title)),
                                          "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(TrangThai.Value = "DaDuyet", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title))),
                                          "DonTuChoi", CountRows(Filter(DonNghiPhep, And(TrangThai.Value = "TuChoi", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title))),
                                          "TongNgayNghi", Sum(Filter(DonNghiPhep, And(TrangThai.Value = "DaDuyet", LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = ThisRecord.Title)), SoNgayNghi)
                                        ),
                                        []
                                      ),
                                      "Employee", 
                                      //Employee report with permission filtering
                                      If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                        //Admin/HR - All employees
                                        AddColumns(
                                          ShowColumns(Filter(NguoiDung, TrangThai.Value = "HoatDong"), "HoTen", "Title", "ChucDanh"),
                                          "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                          "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                          "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                          "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                        ),
                                        //Manager - Team members only
                                        If(varUserPermissions.CanViewTeamLeaves,
                                          With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                            AddColumns(
                                              ShowColumns(teamMembers, "HoTen", "Title", "ChucDanh"),
                                              "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                              "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                              "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                              "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                            )
                                          ),
                                          //Employee - Personal data only
                                          AddColumns(
                                            ShowColumns(Filter(NguoiDung, Title = UserSessionANP.Id), "HoTen", "Title", "ChucDanh"),
                                            "TongDonNghi", CountRows(Filter(DonNghiPhep, MaNguoiDung.Value = ThisRecord.Title)),
                                            "DonDaDuyet", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet"))),
                                            "DonTuChoi", CountRows(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "TuChoi"))),
                                            "TongNgayNghi", Sum(Filter(DonNghiPhep, And(MaNguoiDung.Value = ThisRecord.Title, TrangThai.Value = "DaDuyet")), SoNgayNghi)
                                          )
                                        )
                                      ),
                                      "LeaveType", 
                                      //Leave type report - available for all users
                                      AddColumns(
                                        LoaiNghi,
                                        "SoLanSuDung", 
                                        If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                          CountRows(Filter(DonNghiPhep, MaLoai.Value = ThisRecord.MaLoai)),
                                          If(varUserPermissions.CanViewTeamLeaves,
                                            With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                              CountRows(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, MaNguoiDung.Value in ShowColumns(teamMembers, "Title"))))
                                            ),
                                            CountRows(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, MaNguoiDung.Value = UserSessionANP.Id)))
                                          )
                                        ),
                                        "TongNgayNghi", 
                                        If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                          Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet")), SoNgayNghi),
                                          If(varUserPermissions.CanViewTeamLeaves,
                                            With({teamMembers: Filter(NguoiDung, MaQuanLy.Value = UserSessionANP.Id)},
                                              Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet", MaNguoiDung.Value in ShowColumns(teamMembers, "Title"))), SoNgayNghi)
                                            ),
                                            Sum(Filter(DonNghiPhep, And(MaLoai.Value = ThisRecord.MaLoai, TrangThai.Value = "DaDuyet", MaNguoiDung.Value = UserSessionANP.Id)), SoNgayNghi)
                                          )
                                        )
                                      ),
                                      []
                                    ),
                                    //Demo data fallback when not authenticated
                                    []
                                  )
                                ); 
                                Set(varIsGenerating, false);
                                Notify(Concatenate("Đã tạo báo cáo ", varReportType, " với ", Text(CountRows(varReportData)), " bản ghi"), NotificationType.Success)

                        - 'Reports.Filter.Summary':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.75
                              Width: =Parent.Width * 0.97
                              Height: =Parent.Height * 0.2
                              Text: =Concatenate("Hiển thị ", Text(CountRows(varReportData)), " " & "kết quả cho loại", ":" & " ", varReportType, " ", 
                                If(Or(varUserPermissions.CanViewAllLeaves, varUserPermissions.CanManageUsers),
                                  "(Toàn công ty)",
                                  If(varUserPermissions.CanViewTeamLeaves,
                                    "(Nhóm của bạn)",
                                    "(Cá nhân)"
                                  )
                                )
                                )
                              Color: =RGBA(107, 114, 128, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Normal
                              Size: =FontSizes.Base
                              Align: =Align.Left

                  - 'Reports.Chart.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Reports.Filter.Container'.Y + 'Reports.Filter.Container'.Height + Parent.Height * 0.015
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.35
                        Visible: =CountRows(varReportData) > 0
                      Children:
                        - 'Reports.Chart.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1

                        - 'Reports.Chart.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.12
                              Text: =Switch(varReportType, 
                                "Monthly", "Biểu đồ thống kê nghỉ phép theo tháng", 
                                "Department", "Biểu đồ thống kê nghỉ phép theo phòng ban",
                                "Employee", "Biểu đồ thống kê nghỉ phép theo nhân viên",
                                "LeaveType", "Biểu đồ thống kê theo loại nghỉ phép",
                                "Biểu đồ thống kê")
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =FontSizes.Large

                        - 'Reports.Chart.TypeSelector':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.18
                              Width: =Parent.Width * 0.3
                              Height: =Parent.Height * 0.08
                            Children:
                              - 'Reports.Chart.Type.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width * 0.3
                                    Height: =Parent.Height
                                    Text: ="Kiểu biểu đồ:"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Normal
                                    Size: =FontSizes.Base
                                    Align: =Align.Center

                              - 'Reports.Chart.Type.Dropdown':
                                  Control: Classic/DropDown
                                  Properties:
                                    X: =Parent.Width * 0.35
                                    Y: =0
                                    Width: =Parent.Width * 0.6
                                    Height: =Parent.Height
                                    Items: =Switch(varReportType,
                                      "Monthly", ["Column", "Line"],
                                      "Department", ["Column", "Pie"],
                                      "Employee", ["Column", "Line"],
                                      "LeaveType", ["Column", "Pie"],
                                      ["Column"])
                                    Default: ="Column"
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    OnChange: |
                                      =Set(varChartType, Self.Selected.Value)

                        - 'Reports.Chart.ColumnChart':
                            Control: BarChart
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.28
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.68
                              Items: =varReportData
                              NumberOfSeries: =1
                              Visible: =And(CountRows(varReportData) > 0, Or(IsBlank(varChartType), varChartType = "Column"))

                        - 'Reports.Chart.LineChart':
                            Control: LineChart
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.28
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.68
                              Items: =varReportData
                              NumberOfSeries: =1
                              Visible: =And(CountRows(varReportData) > 0, varChartType = "Line", Or(varReportType = "Monthly", varReportType = "Employee"))

                        - 'Reports.Chart.PieChart':
                            Control: PieChart
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.28
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.68
                              Items: =varReportData
                              Visible: =And(CountRows(varReportData) > 0, varChartType = "Pie", Or(varReportType = "Department", varReportType = "LeaveType"))

                        - 'Reports.Chart.Summary':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.7
                              Y: =Parent.Height * 0.18
                              Width: =Parent.Width * 0.28
                              Height: =Parent.Height * 0.08
                              Text: |
                                =Switch(varReportType,
                                  "Monthly", Concatenate("Tổng: ", Text(Sum(varReportData, SoDon)), " đơn"),
                                  "Department", Concatenate("Tổng: ", Text(CountRows(varReportData)), " phòng ban"),
                                  "Employee", Concatenate("Tổng: ", Text(CountRows(varReportData)), " nhân viên"),
                                  "LeaveType", Concatenate("Tổng: ", Text(CountRows(varReportData)), " loại nghỉ"),
                                  "")
                              Color: =RGBA(59, 130, 246, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =FontSizes.Base
                              Align: =Align.Center

      - 'Reports.DataTable':
          Control: DataTable
          Properties:
            X: ='Reports.Navigation'.Width + 'Reports.Content.Container'.Width * 0.02
            Y: ='Reports.Header'.Height + 'Reports.Content.Container'.Height * 0.75
            Width: ='Reports.Content.Container'.Width * 0.96
            Height: ='Reports.Content.Container'.Width * 0.22
            Items: =varReportData
            BorderColor: =RGBA(229, 231, 235, 1)
            BorderThickness: =1
            Font: =Font.'Open Sans'
            Size: =FontSizes.Base
            Color: =RGBA(55, 65, 81, 1)
            HeadingColor: =RGBA(255, 255, 255, 1)
            HeadingFill: =RGBA(59, 130, 246, 1)
            Visible: |
              =And(varCanAccessReports, CountRows(varReportData) > 0)
          Children:
            - Column1:
                Control: DataTableColumn
                Variant: Textual
                Properties:
                  FieldDisplayName: =Switch(varReportType, "Monthly", "Tháng", "Department", "Phòng ban", "Employee", "Nhân viên", "LeaveType", "Loại nghỉ", "Tên")
                  FieldName: ="Name"
                  Order: =1
                  Text: =Switch(varReportType, "Department", Parent.Selected.TenDonVi, "Employee", Parent.Selected.HoTen, "LeaveType", Parent.Selected.TenLoai, "Monthly", Parent.Selected.TenThang, "N/A")
                  Width: =Parent.Width * 0.25

            - Column2:
                Control: DataTableColumn
                Variant: Textual
                Properties:
                  FieldDisplayName: =Switch(varReportType, "Department", "Tổng NV", "Employee", "Tổng đơn", "LeaveType", "Số lần dùng", "Monthly", "Số đơn", "Giá trị 1")
                  FieldName: ="Value1"
                  Order: =2
                  Text: =Switch(varReportType, "Department", Text(Parent.Selected.TongNhanVien), "Employee", Text(Parent.Selected.TongDonNghi), "LeaveType", Text(Parent.Selected.SoLanSuDung), "Monthly", Text(Parent.Selected.SoDon), "0")
                  Width: =Parent.Width * 0.18

            - Column3:
                Control: DataTableColumn
                Variant: Textual
                Properties:
                  FieldDisplayName: =Switch(varReportType, "Department", "Đã duyệt", "Employee", "Đã duyệt", "LeaveType", "Tổng ngày", "Monthly", "Đã duyệt", "Giá trị 2")
                  FieldName: ="Value2"
                  Order: =3
                  Text: =Switch(varReportType, "Department", Text(Parent.Selected.DonDaDuyet), "Employee", Text(Parent.Selected.DonDaDuyet), "LeaveType", Text(Parent.Selected.TongNgayNghi), "Monthly", Text(Parent.Selected.SoDonDuyet), "0")
                  Width: =Parent.Width * 0.18

            - Column4:
                Control: DataTableColumn
                Variant: Textual
                Properties:
                  FieldDisplayName: =Switch(varReportType, "Department", "Tổng ngày nghỉ", "Employee", "Tổng ngày nghỉ", "LeaveType", "Mô tả", "Monthly", "Tổng ngày nghỉ", "Giá trị 3")
                  FieldName: ="Value3"
                  Order: =4
                  Text: =Switch(varReportType, "Department", Text(Parent.Selected.TongNgayNghi), "Employee", Text(Parent.Selected.TongNgayNghi), "LeaveType", "Có lương", "Monthly", Text(Parent.Selected.TongNgayNghi), "0")
                  Width: =Parent.Width * 0.22

      - 'Reports.Export.Overlay':
          Control: Rectangle
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height
            Fill: =RGBA(0, 0, 0, 0.5)
            Visible: =varShowExportOptions
            OnSelect: |
              =Set(varShowExportOptions, false)
            
      - 'Reports.Export.Modal':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =(Parent.Width - Self.Width) / 2
            Y: =(Parent.Height - Self.Height) / 2
            Width: =Parent.Width * 0.4
            Height: =Parent.Height * 0.3
            Fill: =RGBA(255, 255, 255, 1)
            BorderColor: =RGBA(226, 232, 240, 1)
            BorderThickness: =2
            Visible: =varShowExportOptions
          Children:
            - 'Reports.Export.Header':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =0
                  Y: =0
                  Width: =Parent.Width
                  Height: =Parent.Height * 0.2
                  Fill: =RGBA(59, 130, 246, 1)
                Children:
                  - 'Reports.Export.Title':
                      Control: Label
                      Properties:
                        X: =Parent.Width * 0.05
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.9
                        Height: =Parent.Height * 0.6
                        Text: ="Xuất báo cáo"
                        Color: =RGBA(255, 255, 255, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =FontSizes.Medium

            - 'Reports.Export.Content':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.05
                  Y: =Parent.Height * 0.25
                  Width: =Parent.Width * 0.9
                  Height: =Parent.Height * 0.5
                Children:
                  - 'Reports.Export.Message':
                      Control: Label
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.3
                        Text: =Concatenate("Xuất ", CountRows(varReportData), " bản ghi dữ liệu thành file CSV")
                        Color: =RGBA(55, 65, 81, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =FontSizes.Small
                        Wrap: =true

                  - 'Reports.Export.Options':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =Parent.Height * 0.35
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.6
                      Children:
                        - 'Reports.Export.Option1':
                            Control: Classic/CheckBox
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height * 0.25
                              Text: ="Báo cáo hiện tại (" & varReportType & ")"
                              Default: =true
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Small

                        - 'Reports.Export.Option2':
                            Control: Classic/CheckBox
                            Properties:
                              X: =0
                              Y: =Parent.Height * 0.3
                              Width: =Parent.Width
                              Height: =Parent.Height * 0.25
                              Text: ="Báo cáo tổng hợp tất cả đơn nghỉ phép"
                              Default: =false
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Small
                              Visible: =Or(UserCanExportReports, UserCanViewAllLeaves, UserCanSystemAdmin)

                        - 'Reports.Export.Option3':
                            Control: Classic/CheckBox
                            Properties:
                              X: =0
                              Y: =Parent.Height * 0.6
                              Width: =Parent.Width
                              Height: =Parent.Height * 0.25
                              Text: ="Báo cáo chi tiết theo phòng ban"
                              Default: =false
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Small
                              Visible: =Or(UserCanExportReports, UserCanViewAllLeaves, UserCanSystemAdmin)

            - 'Reports.Export.Actions':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.05
                  Y: =Parent.Height * 0.8
                  Width: =Parent.Width * 0.9
                  Height: =Parent.Height * 0.15
                Children:
                  - 'Reports.Export.Cancel':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width * 0.45
                        Height: =Parent.Height
                        Text: ="Hủy"
                        Size: ="Medium"
                        OnClick: =Set(varShowExportOptions, false)

                  - 'Reports.Export.Confirm':
                      Control: Export
                      Properties:
                        X: =Parent.Width * 0.55
                        Y: =0
                        Width: =Parent.Width * 0.45
                        Height: =Parent.Height
                        Text: ="Xuất CSV"
                        Data: =varReportData
                        BorderColor: =ColorFade(RGBA(59, 130, 246, 1), -15%)
                        Color: =RGBA(255, 255, 255, 1)
                        Fill: =RGBA(59, 130, 246, 1)
                        Font: =Font.'Open Sans'
                        HoverBorderColor: =ColorFade(RGBA(59, 130, 246, 1), 20%)
                        HoverColor: =RGBA(255, 255, 255, 1)
                        HoverFill: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                        PressedBorderColor: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                        PressedFill: =ColorFade(RGBA(59, 130, 246, 1), -20%)
                        OnSelect: |
                          =Notify(Concatenate("Đã xuất báo cáo ", varReportType, " thành file CSV với ", CountRows(varReportData), " bản ghi"), NotificationType.Success);
                          Set(varShowExportOptions, false) 