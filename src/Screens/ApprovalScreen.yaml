Screens:
  ApprovalScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =Set(varActiveScreen, "Approval"); 
        // Use session from Login or fallback to Microsoft 365 lookup
        If(IsBlank(varCurrentUser), 
          Set(varCurrentUser, LookUp(NguoiDung, Email = User().Email)));
        // Validate current user session
        If(IsBlank(varCurrentUser), 
          Navigate(LoginScreen), 
          // Continue with screen initialization using session data
          Set(varUserPermissions, LookUp(VaiTro, MaVaiTro = varCurrentUser.MaVaiTro).CacQuyen.Value); 
          Set(varApprovalWorkflow, Filter(QuyTrinhDuyet, And(MaDonVi.Value = varCurrentUser.MaDonVi, DangHoatDong = true))); 
          Set(varPendingRequests, Switch(varCurrentUser.MaVaiTro, "MANAGER", Filter(DonNghiPhep, And(TrangThai.Value = "ChoDuyetCap1", MaNhanVien.Value in Filter(NguoiDung, MaQuanLy.Value = varCurrentUser.MaNhanVien.Value).MaNhanVien.Value)), "DIRECTOR", Filter(DonNghiPhep, TrangThai.Value in ["ChoDuyetCap2", "ChoDuyetCap3"]), "HR", Filter(DonNghiPhep, TrangThai.Value in ["ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3"]), [])); 
          Set(varSelectedRequest, Blank()); 
          Set(varApprovalComment, ""); 
          Set(varIsProcessing, false))
    Children:
      - 'Approval.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =Parent.X
            Y: =Parent.Y
            Width: =Parent.Width
            Height: =Parent.Height * 0.06
            UserName: =varCurrentUser.HoTen
            UserRole: =varCurrentUser.MaVaiTro
            ShowNotification: =true
            NotificationCount: =CountRows(varPendingRequests)
            OnLogout: |
              =//LOGOUT: Clear all session data and return to login
              Set(varLoginSuccess, false); Set(varSessionValid, false);
              Set(varLoggedInUserEmail, ""); Clear(UserSession);
              UpdateContext({localLogout: true});
              Navigate(LoginScreen)
            
      - 'Approval.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =Parent.X
            Y: ='Approval.Header'.Y + 'Approval.Header'.Height
            Width: =If(App.Width < 768, 
              If(varMobileMenuOpen, Parent.Width * 0.75, Parent.Width * 0.001),
              If(varNavCollapsed, Parent.Width * 0.06, Parent.Width * 0.2))
            Height: =Parent.Height - 'Approval.Header'.Height
            UserRole: =varCurrentUser.MaVaiTro
            ActiveScreen: =If(IsBlank(varActiveScreen), "Approval", varActiveScreen)
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen),
                "LeaveRequest", Navigate(LeaveRequestScreen),
                "MyLeaves", Navigate(MyLeavesScreen),
                "Calendar", Navigate(CalendarScreen),
                "Management", Navigate(ManagementScreen),
                "Profile", Navigate(ProfileScreen),
                "Approval", Navigate(ApprovalScreen),
                "Reports", Navigate(ReportsScreen)
              )
            
      - 'Approval.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =0
            Y: ='Approval.Header.Container'.Y + 'Approval.Header.Container'.Height
            Width: =Parent.Width
            Height: =Parent.Height - 'Approval.Header.Container'.Height
          Children:
            # Page Title & Stats
            - 'Approval.Content.Header':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: =Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.1
                Children:
                  - 'Approval.Content.Title':
                      Control: Label
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width * 0.6
                        Height: =Parent.Height * 0.5
                        Text: ="Phê duyệt đơn nghỉ phép"
                        Color: =RGBA(32, 54, 71, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =Parent.Height * 0.25
                        
                  - 'Approval.Content.Stats':
                      Control: Label
                      Properties:
                        X: =0
                        Y: ='Approval.Content.Title'.Y + 'Approval.Content.Title'.Height
                        Width: =Parent.Width * 0.6
                        Height: =Parent.Height * 0.35
                        Text: |
                          =Concatenate(
                          "Cấp phê duyệt:", varMyApprovalLevel, 
                          " | Đơn chờ xử lý:", CountRows(varPendingRequests),
                          " | Vai trò:", LookUp(VaiTro, MaVaiTro = varCurrentUser.MaVaiTro).TenVaiTro)
                        Color: =RGBA(108, 117, 125, 1)
                        Font: =Font.'Open Sans'
                        Size: =Parent.Height * 0.15
                        
                  # Filter Controls
                  - 'Approval.Content.FilterContainer':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.65
                        Y: =0
                        Width: =Parent.Width * 0.35
                        Height: =Parent.Height
                      Children:
                        - 'Approval.Content.Filter.Label':
                            Control: Label
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height * 0.3
                              Text: ="Lọc theo trạng thái:"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              Size: =Parent.Height * 0.12
                              
                        - 'Approval.Content.Filter.Dropdown':
                            Control: Classic/DropDown
                            Properties:
                              X: =0
                              Y: =Parent.Height * 0.35
                              Width: =Parent.Width
                              Height: =Parent.Height * 0.6
                              Items: =["All", "ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3", "DaDuyet", "TuChoi"]
                              Default: =varFilterStatus
                              OnChange: =Set(varFilterStatus, Self.Selected.Value); Set(varFilteredRequests, If(varFilterStatus = "All", varPendingRequests, Filter(varPendingRequests, TrangThai = varFilterStatus)))
                              
            # Requests List
            - 'Approval.RequestsList.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='Approval.Content.Header'.Y + 'Approval.Content.Header'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.8
                  Fill: =RGBA(255, 255, 255, 1)
                  BorderColor: =RGBA(230, 230, 230, 1)
                  BorderThickness: =Parent.Width * 0.001
                  DropShadow: =DropShadow.Light
                Children:
                  - 'Approval.RequestsList.Header':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =Parent.Width * 0.02
                        Y: =Parent.Height * 0.02
                        Width: =Parent.Width * 0.96
                        Height: =Parent.Height * 0.08
                        Fill: =RGBA(248, 249, 250, 1)
                        BorderColor: =RGBA(229, 231, 235, 1)
                        BorderThickness: =Parent.Width * 0.0005
                      Children:
                        - 'Approval.RequestsList.Header.Employee':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.6
                              Text: ="Nhân viên"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                        - 'Approval.RequestsList.Header.LeaveType':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.2
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.15
                              Height: =Parent.Height * 0.6
                              Text: ="Loại nghỉ"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                        - 'Approval.RequestsList.Header.DateRange':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.35
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.2
                              Height: =Parent.Height * 0.6
                              Text: ="Thời gian nghỉ"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                        - 'Approval.RequestsList.Header.Days':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.55
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.1
                              Height: =Parent.Height * 0.6
                              Text: ="Số ngày"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                        - 'Approval.RequestsList.Header.Status':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.65
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.15
                              Height: =Parent.Height * 0.6
                              Text: ="Trạng thái"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                        - 'Approval.RequestsList.Header.Actions':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.8
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.18
                              Height: =Parent.Height * 0.6
                              Text: ="Thao tác"
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =Parent.Height * 0.3
                              
                  # Requests Gallery
                  - 'Approval.RequestsList.Gallery':
                      Control: Gallery
                      Variant: Vertical
                      Properties:
                        X: =Parent.Width * 0.02
                        Y: ='Approval.RequestsList.Header'.Y + 'Approval.RequestsList.Header'.Height + Parent.Height * 0.01
                        Width: =Parent.Width * 0.96
                        Height: =Parent.Height * 0.85
                        Items: =If(IsBlank(varFilteredRequests), varPendingRequests, varFilteredRequests)
                        TemplateSize: =Self.Height * 0.12
                        TemplatePadding: =Self.Height * 0.005
                        BorderThickness: =0
                        Fill: =RGBA(0, 0, 0, 0)
                      Children:
                        - 'Approval.RequestsList.Gallery.Row':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.TemplateX
                              Y: =Parent.TemplateY
                              Width: =Parent.TemplateWidth
                              Height: =Parent.TemplateHeight
                              Fill: =If(Mod(ThisItem.'#Row', 2) = 0, RGBA(255, 255, 255, 1), RGBA(248, 249, 250, 1))
                              BorderColor: =RGBA(229, 231, 235, 1)
                              BorderThickness: =Parent.Width * 0.0002
                            Children:
                              # Employee Info
                              - 'Approval.RequestsList.Gallery.Employee':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.1
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.8
                                  Children:
                                    - 'Approval.RequestsList.Gallery.EmployeeName':
                                        Control: Label
                                        Properties:
                                          X: =0
                                          Y: =0
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.5
                                          Text: =LookUp(NguoiDung, MaNhanVien = ThisItem.MaNhanVien).HoTen
                                          Color: =RGBA(32, 54, 71, 1)
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =Parent.Height * 0.25
                                          
                                    - 'Approval.RequestsList.Gallery.EmployeeCode':
                                        Control: Label
                                        Properties:
                                          X: =Parent.X
                                          Y: ='Approval.RequestsList.Gallery.EmployeeName'.Y + 'Approval.RequestsList.Gallery.EmployeeName'.Height
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.35
                                          Text: =ThisItem.MaNhanVien
                                          Color: =RGBA(107, 114, 128, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =Parent.Height * 0.2
                                          
                                    - 'Approval.RequestsList.Gallery.Department':
                                        Control: Label
                                        Properties:
                                          X: =Parent.X
                                          Y: ='Approval.RequestsList.Gallery.EmployeeCode'.Y + 'Approval.RequestsList.Gallery.EmployeeCode'.Height
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.15
                                          Text: =LookUp(DonVi, MaDonVi = LookUp(NguoiDung, MaNhanVien = ThisItem.MaNhanVien).MaDonVi).TenDonVi
                                          Color: =RGBA(107, 114, 128, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =Parent.Height * 0.12
                                          
                              # Leave Type
                              - 'Approval.RequestsList.Gallery.LeaveType':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.2
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.15
                                    Height: =Parent.Height * 0.4
                                    Text: =LookUp(LoaiNghi, MaLoai = ThisItem.MaLoai).TenLoai
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =Parent.Height * 0.18
                                    
                              # Date Range
                              - 'Approval.RequestsList.Gallery.DateRange':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =Parent.Width * 0.35
                                    Y: =Parent.Height * 0.1
                                    Width: =Parent.Width * 0.2
                                    Height: =Parent.Height * 0.8
                                  Children:
                                    - 'Approval.RequestsList.Gallery.StartDate':
                                        Control: Label
                                        Properties:
                                          X: =Parent.X
                                          Y: =Parent.Y
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.4
                                          Text: =Text(ThisItem.NgayBatDau, "dd/mm/yyyy")
                                          Color: =RGBA(55, 65, 81, 1)
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =Parent.Height * 0.2
                                          
                                    - 'Approval.RequestsList.Gallery.EndDate':
                                        Control: Label
                                        Properties:
                                          X: =Parent.X
                                          Y: ='Approval.RequestsList.Gallery.StartDate'.Y + 'Approval.RequestsList.Gallery.StartDate'.Height
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.4
                                          Text: =Text(ThisItem.NgayKetThuc, "dd/mm/yyyy")
                                          Color: =RGBA(107, 114, 128, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =Parent.Height * 0.18
                                          
                                    - 'Approval.RequestsList.Gallery.Session':
                                        Control: Label
                                        Properties:
                                          X: =Parent.X
                                          Y: ='Approval.RequestsList.Gallery.EndDate'.Y + 'Approval.RequestsList.Gallery.EndDate'.Height
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.2
                                          Text: =Switch(ThisItem.BuoiNghi, 
                                            "CaNgay", "Cả ngày",
                                            "BuoiSang", "Buổi sáng", 
                                            "BuoiChieu", "Buổi chiều",
                                            ThisItem.BuoiNghi)
                                          Color: =RGBA(107, 114, 128, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =Parent.Height * 0.12
                                          
                              # Days Count
                              - 'Approval.RequestsList.Gallery.Days':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.55
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.1
                                    Height: =Parent.Height * 0.4
                                    Text: =ThisItem.SoNgayNghi & " ngày"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =Parent.Height * 0.18
                                    Align: =Align.Center
                                    
                              # Status Badge
                              - 'Approval.RequestsList.Gallery.Status':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.65
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.15
                                    Height: =Parent.Height * 0.5
                                    Text: =Switch(ThisItem.TrangThai,
                                      "ChoDuyetCap1", "Chờ cấp 1",
                                      "ChoDuyetCap2", "Chờ cấp 2",
                                      "ChoDuyetCap3", "Chờ cấp 3",
                                      "DaDuyet", "Đã duyệt",
                                      "TuChoi", "Từ chối",
                                      "Huy", "Đã hủy",
                                      "HetHan", "Hết hạn",
                                      ThisItem.TrangThai)
                                    Color: =Switch(ThisItem.TrangThai,
                                      "DaDuyet", RGBA(76, 175, 80, 1),
                                      "TuChoi", RGBA(244, 67, 54, 1),
                                      "ChoDuyetCap1", RGBA(255, 152, 0, 1),
                                      "ChoDuyetCap2", RGBA(255, 152, 0, 1),
                                      "ChoDuyetCap3", RGBA(255, 152, 0, 1),
                                      "HetHan", RGBA(158, 158, 158, 1),
                                      RGBA(107, 114, 128, 1))
                                    Fill: =Switch(ThisItem.TrangThai,
                                      "DaDuyet", RGBA(232, 245, 233, 1),
                                      "TuChoi", RGBA(255, 235, 238, 1),
                                      "ChoDuyetCap1", RGBA(255, 243, 224, 1),
                                      "ChoDuyetCap2", RGBA(255, 243, 224, 1),
                                      "ChoDuyetCap3", RGBA(255, 243, 224, 1),
                                      RGBA(248, 250, 252, 1))
                                    BorderColor: =Switch(ThisItem.TrangThai,
                                      "DaDuyet", RGBA(200, 230, 201, 1),
                                      "TuChoi", RGBA(255, 205, 210, 1),
                                      "ChoDuyetCap1", RGBA(255, 224, 178, 1),
                                      "ChoDuyetCap2", RGBA(255, 224, 178, 1),
                                      "ChoDuyetCap3", RGBA(255, 224, 178, 1),
                                      RGBA(224, 224, 224, 1))
                                    BorderThickness: =Parent.Width * 0.001
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =Parent.Height * 0.15
                                    Align: =Align.Center
                                    
                              # Action Buttons
                              - 'Approval.RequestsList.Gallery.Actions':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =Parent.Width * 0.8
                                    Y: =Parent.Height * 0.1
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.8
                                  Children:
                                    # View Details Button
                                    - 'Approval.RequestsList.Gallery.ViewButton':
                                        Control: CanvasComponent
                                        ComponentName: ButtonComponent
                                        Properties:
                                          X: =Parent.X
                                          Y: =Parent.Y
                                          Width: =Parent.Width * 0.45
                                          Height: =Parent.Height * 0.4
                                          Text: ="Chi tiết"
                                          Variant: ="Outline"
                                          Size: ="Small"
                                          Icon: ="View"
                                          OnClick: |
                                                    =Set(varSelectedRequest, ThisItem);
                                                    Set(varShowRequestDetails, true)
                                          
                                    # Approve Button (only for pending requests at user's level)
                                    - 'Approval.RequestsList.Gallery.ApproveButton':
                                        Control: CanvasComponent
                                        ComponentName: ButtonComponent
                                        Properties:
                                          X: =Parent.Width * 0.55
                                          Y: =Parent.Y
                                          Width: =Parent.Width * 0.45
                                          Height: =Parent.Height * 0.4
                                          Text: ="Duyệt"
                                          Variant: ="Primary"
                                          Size: ="Small"
                                          Icon: ="Check"
                                          Visible: =And(
                                            ThisItem.TrangThai = Switch(varMyApprovalLevel,
                                              1, "ChoDuyetCap1",
                                              2, "ChoDuyetCap2", 
                                              3, "ChoDuyetCap3",
                                              ""),
                                            Not(varIsProcessing))
                                          OnClick: |
                                                    =Set(varSelectedRequest, ThisItem);
                                                    Set(varApprovalAction, "Approve");
                                                    Set(varApprovalComment, "");
                                                    Set(varShowApprovalModal, true)
                                          
                                    # Reject Button
                                    - 'Approval.RequestsList.Gallery.RejectButton':
                                        Control: CanvasComponent
                                        ComponentName: ButtonComponent
                                        Properties:
                                          X: =Parent.X
                                          Y: =Parent.Height * 0.6
                                          Width: =Parent.Width * 0.45
                                          Height: =Parent.Height * 0.4
                                          Text: ="Từ chối"
                                          Variant: ="Danger"
                                          Size: ="Small"
                                          Icon: ="Cancel"
                                          Visible: =And(
                                            ThisItem.TrangThai in ["ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3"],
                                            Or(
                                              And(varMyApprovalLevel = 1, ThisItem.TrangThai = "ChoDuyetCap1"),
                                              And(varMyApprovalLevel = 2, ThisItem.TrangThai in ["ChoDuyetCap2", "ChoDuyetCap3"]),
                                              And(varMyApprovalLevel = 3, ThisItem.TrangThai = "ChoDuyetCap3"),
                                              varCurrentUser.MaVaiTro = "HR"
                                            ),
                                            Not(varIsProcessing))
                                          OnClick: |
                                                    =Set(varSelectedRequest, ThisItem);
                                                    Set(varApprovalAction, "Reject");
                                                    Set(varApprovalComment, "");
                                                    Set(varShowApprovalModal, true)
                                          
                                    # Reassign Button (HR only)
                                    - 'Approval.RequestsList.Gallery.ReassignButton':
                                        Control: CanvasComponent
                                        ComponentName: ButtonComponent
                                        Properties:
                                          X: =Parent.Width * 0.55
                                          Y: =Parent.Height * 0.6
                                          Width: =Parent.Width * 0.45
                                          Height: =Parent.Height * 0.4
                                          Text: ="Chuyển"
                                          Variant: ="Secondary"
                                          Size: ="Small"
                                          Icon: ="Forward"
                                          Visible: =And(
                                            varCurrentUser.MaVaiTro = "HR",
                                            ThisItem.TrangThai in ["ChoDuyetCap1", "ChoDuyetCap2", "ChoDuyetCap3"],
                                            Not(varIsProcessing))
                                          OnClick: |
                                                    =Set(varSelectedRequest, ThisItem);
                                                    Set(varApprovalAction, "Reassign");
                                                    Set(varShowApprovalModal, true)
                                          
      # Approval Modal
      - 'Approval.Modal.Overlay':
          Control: Rectangle
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height
            Fill: =RGBA(0, 0, 0, 0.5)
            Visible: =varShowApprovalModal
            OnSelect: |
              =Set(varShowApprovalModal, false)
            
      - 'Approval.Modal.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =(Parent.Width - Self.Width) / 2
            Y: =(Parent.Height - Self.Height) / 2
            Width: =Parent.Width * 0.5
            Height: =Parent.Height * 0.6
            Fill: =RGBA(255, 255, 255, 1)
            BorderColor: =RGBA(200, 200, 200, 1)
            BorderThickness: =Parent.Width * 0.002
            DropShadow: =DropShadow.Bold
            Visible: =varShowApprovalModal
          Children:
            # Modal Header
            - 'Approval.Modal.Header':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.X
                  Y: =Parent.Y
                  Width: =Parent.Width
                  Height: =Parent.Height * 0.15
                  Fill: =Switch(varApprovalAction,
                    "Approve", RGBA(232, 245, 233, 1),
                    "Reject", RGBA(255, 235, 238, 1),
                    RGBA(248, 249, 250, 1))
                  BorderColor: =RGBA(229, 231, 235, 1)
                  BorderThickness: =Parent.Width * 0.001
                Children:
                  - 'Approval.Modal.Title':
                      Control: Label
                      Properties:
                        X: =Parent.Width * 0.03
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.8
                        Height: =Parent.Height * 0.6
                        Text: =Switch(varApprovalAction,
                          "Approve", "Phê duyệt đơn nghỉ phép",
                          "Reject", "Từ chối đơn nghỉ phép",
                          "Reassign", "Chuyển đơn xử lý",
                          "Xác nhận thao tác")
                        Color: =RGBA(32, 54, 71, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =Parent.Height * 0.3
                        
                  - 'Approval.Modal.CloseButton':
                      Control: Classic/Icon
                      Properties:
                        X: =Parent.Width - Self.Width - Parent.Width * 0.03
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Height * 0.4
                        Height: =Parent.Height * 0.4
                        Icon: =Icon.Cancel
                        Color: =RGBA(107, 114, 128, 1)
                        OnSelect: |
                          =Set(varShowApprovalModal, false)
                        
            # Request Details
            - 'Approval.Modal.RequestDetails':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='Approval.Modal.Header'.Y + 'Approval.Modal.Header'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.4
                Children:
                  - 'Approval.Modal.EmployeeInfo':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: =Parent.Y
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.2
                        Text: =Concatenate(
                          "Nhân viên:", LookUp(NguoiDung, MaNhanVien = varSelectedRequest.MaNhanVien).HoTen,
                          " (", varSelectedRequest.MaNhanVien, ")")
                        Color: =RGBA(32, 54, 71, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =Parent.Height * 0.08
                        
                  - 'Approval.Modal.LeaveDetails':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: ='Approval.Modal.EmployeeInfo'.Y + 'Approval.Modal.EmployeeInfo'.Height
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.6
                        Text: =Concatenate(
                          "Loại nghỉ:", LookUp(LoaiNghi, MaLoai = varSelectedRequest.MaLoai).TenLoai, Char(10),
                          "Thời gian:", Text(varSelectedRequest.NgayBatDau, "dd/mm/yyyy"), " - ", Text(varSelectedRequest.NgayKetThuc, "dd/mm/yyyy"), Char(10),
                          "Số ngày:", varSelectedRequest.SoNgayNghi, " ngày", Char(10),
                          "Lý do:", varSelectedRequest.LyDo
                        )
                        Color: =RGBA(55, 65, 81, 1)
                        Font: =Font.'Open Sans'
                        Size: =Parent.Height * 0.06
                        
                  - 'Approval.Modal.CurrentStatus':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: ='Approval.Modal.LeaveDetails'.Y + 'Approval.Modal.LeaveDetails'.Height
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.2
                        Text: =Concatenate("Trạng thái hiện tại:", varSelectedRequest.TrangThai)
                        Color: =RGBA(107, 114, 128, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =Parent.Height * 0.08
                        
            # Comment Section
            - 'Approval.Modal.CommentSection':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='Approval.Modal.RequestDetails'.Y + 'Approval.Modal.RequestDetails'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.25
                Children:
                  - 'Approval.Modal.CommentLabel':
                      Control: Label
                      Properties:
                        X: =Parent.X
                        Y: =Parent.Y
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.25
                        Text: =Switch(varApprovalAction,
                          "Approve", "Ghi chú phê duyệt (không bắt buộc):",
                          "Reject", "Lý do từ chối (bắt buộc):",
                          "Reassign", "Ghi chú chuyển đơn:",
                          "Ghi chú:")
                        Color: =RGBA(55, 65, 81, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Semibold
                        Size: =Parent.Height * 0.12
                        
                  - 'Approval.Modal.CommentInput':
                      Control: Classic/TextInput
                      Properties:
                        X: =Parent.X
                        Y: ='Approval.Modal.CommentLabel'.Y + 'Approval.Modal.CommentLabel'.Height
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.75
                        HintText: =Switch(varApprovalAction,
                          "Approve", "Nhập ghi chú phê duyệt...",
                          "Reject", "Nhập lý do từ chối...",
                          "Reassign", "Nhập ghi chú chuyển đơn...",
                          "Nhập ghi chú...")
                        Default: =varApprovalComment
                        OnChange: =Set(varApprovalComment, Self.Text)
                        Mode: =TextMode.MultiLine
                        
            # Action Buttons
            - 'Approval.Modal.Actions':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='Approval.Modal.CommentSection'.Y + 'Approval.Modal.CommentSection'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.12
                Children:
                  # Confirm Button
                  - 'Approval.Modal.ConfirmButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width - (Self.Width * 2) - Parent.Width * 0.02
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.25
                        Height: =Parent.Height * 0.8
                        Text: =Switch(varApprovalAction,
                          "Approve", "Xác nhận duyệt",
                          "Reject", "Xác nhận từ chối", 
                          "Reassign", "Xác nhận chuyển",
                          "Xác nhận")
                        Variant: =Switch(varApprovalAction,
                          "Approve", "Primary",
                          "Reject", "Danger",
                          "Secondary")
                        IsLoading: =varIsProcessing
                        LoadingText: ="Đang xử lý..."
                        IsDisabled: =Or(
                          varIsProcessing,
                          And(varApprovalAction = "Reject", IsBlank(varApprovalComment))
                        )
                        OnClick: |
                                  =Set(varIsProcessing, true);
                                  With(varSelectedRequest,
                                    Switch(varApprovalAction,
                                      "Approve", 
                                        Patch(DonNghiPhep, LookUp(DonNghiPhep, MaDon = MaDon), {
                                          TrangThai: Switch(varMyApprovalLevel,
                                            1, "ChoDuyetCap2",
                                            2, "ChoDuyetCap3", 
                                            3, "DaDuyet",
                                            "DaDuyet"),
                                          GhiChuPheDuyet: If(IsBlank(varApprovalComment), GhiChuPheDuyet, varApprovalComment),
                                          NgayCapNhat: Now(),
                                          NguoiCapNhat: varCurrentUser.MaNhanVien
                                        }),
                                      "Reject",
                                        Patch(DonNghiPhep, LookUp(DonNghiPhep, MaDon = MaDon), {
                                          TrangThai: "TuChoi",
                                          GhiChuPheDuyet: varApprovalComment,
                                          NgayCapNhat: Now(),
                                          NguoiCapNhat: varCurrentUser.MaNhanVien
                                        })
                                    ));
                                  Set(varIsProcessing, false);
                                  Set(varShowApprovalModal, false);
                                  Set(varApprovalComment, "");
                                  Refresh(DonNghiPhep)
                                  
                  # Cancel Button
                  - 'Approval.Modal.CancelButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width - Self.Width
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.2
                        Height: =Parent.Height * 0.8
                        Text: ="Hủy"
                        Variant: ="Outline"
                        OnClick: |
                          =Set(varShowApprovalModal, false); Set(varApprovalComment, "") 
