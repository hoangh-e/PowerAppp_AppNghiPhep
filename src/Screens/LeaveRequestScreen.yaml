Screens:
  LeaveRequestScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =Set(varActiveScreen, "LeaveRequest");
        //Permission checks using inline bitwise expressions
        Set(varUserPermissions, {
          CanCreatePersonalLeaves: UserCanViewPersonalLeaves,
          CanCreateSpecialLeaves: UserCanCreateSpecialLeaves,
          CanViewDashboard: UserCanViewDashboard,
          CanApprove: Or(UserCanApproveLevel1, UserCanApproveLevel2)
        });
        Set(varSelectedFromDate, Blank());
        Set(varSelectedToDate, Blank());
        Set(varSelectedLeaveType, Blank());
        Set(varLeaveReason, "");
        Set(varHandoverPerson, Blank());
        Set(varHandoverContent, "");
        Set(varCalculatedDays, 0);
        Set(varValidationErrors, Blank());
        Set(varIsSubmitting, false);
        Set(varShowSuccessModal, false);
        //Load user data with fallback demo data
        Set(varUserLeaveBalance, 
          If(IsUserAuthenticated,
            LookUp(SoNgayPhep, And(MaNhanVien.Value = UserSession.Id, Nam = Year(Today()))),
            {MaNhanVien: UserSession.Id, Nam: Year(Today()), TongNgayDuocPhep: 12, SoNgayDaNghi: 3, SoNgayConLai: 9}
          )
        );
        Set(varAvailableLeaveTypes, 
          If(IsUserAuthenticated,
            Filter(LoaiNghi, DangHoatDong = true),
            Table(
              {MaLoai: "AL", TenLoai: "Phép năm", CoLuong: true},
              {MaLoai: "SL", TenLoai: "Nghỉ ốm", CoLuong: true},
              {MaLoai: "PL", TenLoai: "Nghỉ việc riêng", CoLuong: false}
            )
          )
        );
        Set(varPotentialHandovers, 
          If(IsUserAuthenticated,
            Filter(NguoiDung, And(TrangThai.Value = "HoatDong", Title <> UserSession.Id)),
            Table(
              {Title: "EMP002", HoTen: "Trần Thị Bình", MaDonVi: "HR"},
              {Title: "EMP003", HoTen: "Lê Hoàng Cường", MaDonVi: "Finance"},
              {Title: "EMP004", HoTen: "Phạm Thị Dung", MaDonVi: "Marketing"}
            )
          )
        );
        Set(varCurrentUser, 
          If(IsUserAuthenticated,
            LookUp(NguoiDung, Title = UserSession.Id),
            {Title: UserSession.Id, HoTen: UserSession.HoTen, MaQuanLy: "MGR001"}
          )
        );
        Set(varUserManager, 
          If(Not(IsBlank(varCurrentUser.MaQuanLy)), 
            If(IsUserAuthenticated,
              LookUp(NguoiDung, Title = varCurrentUser.MaQuanLy.Value),
              {Title: "MGR001", HoTen: "Quản lý Demo"}
            ),
            Blank())
        )
    Children:
      # Header Component
      - 'LeaveRequest.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =UserSession.HoTen
            UserRole: =UserSession.MaVaiTro
            ShowNotification: =true
            NotificationCount: =0
            OnLogout: |
              =Set(varIsUserAuthenticated, false);
              Set(UserSession, {
                Id: "", 
                Name: "", 
                Email: "", 
                Role: "", 
                Permission: 0,
                NguoiQuanLyId: "", 
                HoTen: "", 
                MaVaiTro: "", 
                ChucDanh: "", 
                MaDonVi: "", 
                TrangThai: ""
              });
              Navigate(LoginScreen)
            
      # Navigation Component
      - 'LeaveRequest.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='LeaveRequest.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.045, App.Width * 0.14)
            Height: =Parent.Height - 'LeaveRequest.Header'.Height
            UserRole: =UserSession.MaVaiTro
            ActiveScreen: ="LeaveRequest"
            IsCollapsed: =varNavCollapsed
            DashboardScreen: =DashboardScreen
            LeaveRequestScreen: =LeaveRequestScreen
            MyLeavesScreen: =MyLeavesScreen
            CalendarScreen: =CalendarScreen
            ManagementScreen: =ManagementScreen
            ReportsScreen: =ReportsScreen
            ProfileScreen: =ProfileScreen
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen),
                "LeaveRequest", Navigate(LeaveRequestScreen),
                "MyLeaves", Navigate(MyLeavesScreen),
                "Calendar", Navigate(CalendarScreen),
                "Management", Navigate(ManagementScreen),
                "Profile", Navigate(ProfileScreen),
                "Approval", Navigate(ApprovalScreen),
                "Reports", Navigate(ReportsScreen)
              )
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)
            
      # Main Content Container
      - 'LeaveRequest.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='LeaveRequest.Navigation'.Width
            Y: ='LeaveRequest.Header'.Height
            Width: =Parent.Width - 'LeaveRequest.Navigation'.Width
            Height: =Parent.Height - 'LeaveRequest.Header'.Height
          Children:
            - 'LeaveRequest.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.01
                  Y: =Parent.Height * 0.01
                  Width: =Parent.Width * 0.98
                  Height: =Parent.Height * 0.98
                Children:
                  # Page Header
                  - 'LeaveRequest.PageHeader.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.1
                      Children:
                        - 'LeaveRequest.PageHeader.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        - 'LeaveRequest.PageHeader.Icon':
                            Control: Classic/Icon
                            Properties:
                              X: =Parent.Width * 0.015
                              Y: =Parent.Height * 0.25
                              Width: =Parent.Height * 0.2
                              Height: =Parent.Height * 0.2
                              Icon: =Icon.CalendarBlank
                              Color: =RGBA(59, 130, 246, 1)
                              
                        - 'LeaveRequest.PageHeader.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015 + 'LeaveRequest.PageHeader.Icon'.Width + Parent.Width * 0.01
                              Y: =Parent.Height * 0.2
                              Width: =Parent.Width * 0.6
                              Height: =Parent.Height * 0.35
                              Text: ="Tạo đơn nghỉ phép"
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =FontSizes.Medium
                              
                        - 'LeaveRequest.PageHeader.Stats':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.015 + 'LeaveRequest.PageHeader.Icon'.Width + Parent.Width * 0.01
                              Y: =Parent.Height * 0.6
                              Width: =Parent.Width * 0.6
                              Height: =Parent.Height * 0.25
                              Text: =If(Not(IsBlank(varUserLeaveBalance)), Concatenate("Số ngày phép còn lại" & ":" & " ", varUserLeaveBalance.SoNgayConLai, " ngày"), "Đang tải thông tin nghỉ phép...")
                              Color: =RGBA(75, 85, 99, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Small

                        - 'LeaveRequest.MyLeaves.Button':
                            Control: CanvasComponent
                            ComponentName: ButtonComponent
                            Properties:
                              X: =Parent.Width * 0.75
                              Y: =(Parent.Height - Self.Height) / 2
                              Width: =Parent.Width * 0.22
                              Height: =Parent.Height * 0.6
                              Text: ="Xem đơn của tôi"
                              Size: ="Medium"
                              OnClick: |
                                =Navigate(MyLeavesScreen)

                  # Form Container
                  - 'LeaveRequest.Form.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='LeaveRequest.PageHeader.Container'.Y + 'LeaveRequest.PageHeader.Container'.Height + Parent.Height * 0.015
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.87
                      Children:
                        - 'LeaveRequest.Form.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        # Form Content - Left Column
                        - 'LeaveRequest.Form.LeftColumn':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.025
                              Y: =Parent.Height * 0.03
                              Width: =Parent.Width * 0.45
                              Height: =Parent.Height * 0.94
                            Children:
                              # Leave Type
                              - 'LeaveRequest.LeaveType.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Loại nghỉ phép"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.LeaveType.Dropdown':
                                  Control: Classic/DropDown
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.LeaveType.Label'.Y + 'LeaveRequest.LeaveType.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.07
                                    Items: =varAvailableLeaveTypes
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Fill: =RGBA(255, 255, 255, 1)
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    OnChange: |
                                      =Set(varSelectedLeaveType, Self.Selected)

                              # From Date
                              - 'LeaveRequest.FromDate.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.LeaveType.Dropdown'.Y + 'LeaveRequest.LeaveType.Dropdown'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Ngày bắt đầu"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.FromDate.DatePicker':
                                  Control: Classic/DatePicker
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.FromDate.Label'.Y + 'LeaveRequest.FromDate.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.07
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Fill: =RGBA(255, 255, 255, 1)
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    DefaultDate: =Today()
                                    OnChange: |
                                      =Set(varSelectedFromDate, Self.SelectedDate);
                                      If(Not(IsBlank(varSelectedToDate)),
                                        Set(varCalculatedDays, DateDiff(varSelectedFromDate, varSelectedToDate) + 1),
                                        Set(varCalculatedDays, 1)
                                      )

                              # To Date
                              - 'LeaveRequest.ToDate.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.FromDate.DatePicker'.Y + 'LeaveRequest.FromDate.DatePicker'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Ngày kết thúc"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.ToDate.DatePicker':
                                  Control: Classic/DatePicker
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.ToDate.Label'.Y + 'LeaveRequest.ToDate.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.07
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Fill: =RGBA(255, 255, 255, 1)
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    DefaultDate: =Today()
                                    OnChange: |
                                      =Set(varSelectedToDate, Self.SelectedDate);
                                      If(Not(IsBlank(varSelectedFromDate)),
                                        Set(varCalculatedDays, DateDiff(varSelectedFromDate, varSelectedToDate) + 1)
                                      )

                              # Calculated Days Display
                              - 'LeaveRequest.Days.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.ToDate.DatePicker'.Y + 'LeaveRequest.ToDate.DatePicker'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Số ngày nghỉ"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.Days.Display':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.Days.Label'.Y + 'LeaveRequest.Days.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.07
                                    Text: =varCalculatedDays & " ngày"
                                    Color: =If(varCalculatedDays > 0, RGBA(34, 197, 94, 1), RGBA(239, 68, 68, 1))
                                    Fill: =If(varCalculatedDays > 0, RGBA(240, 253, 244, 1), RGBA(254, 242, 242, 1))
                                    BorderColor: =If(varCalculatedDays > 0, RGBA(34, 197, 94, 1), RGBA(239, 68, 68, 1))
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Medium
                                    Align: =Align.Center

                              # Handover Person
                              - 'LeaveRequest.Handover.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.Days.Display'.Y + 'LeaveRequest.Days.Display'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Người nhận bàn giao"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.Handover.Dropdown':
                                  Control: Classic/DropDown
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.Handover.Label'.Y + 'LeaveRequest.Handover.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.07
                                    Items: =varPotentialHandovers
                                    Default: =If(Not(IsBlank(varUserManager)), [varUserManager], [])
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Fill: =RGBA(255, 255, 255, 1)
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    OnChange: |
                                      =Set(varHandoverPerson, Self.Selected)

                        # Form Content - Right Column  
                        - 'LeaveRequest.Form.RightColumn':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.525
                              Y: =Parent.Height * 0.03
                              Width: =Parent.Width * 0.45
                              Height: =Parent.Height * 0.94
                            Children:
                              # Leave Reason
                              - 'LeaveRequest.Reason.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Lý do nghỉ phép"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.Reason.Input':
                                  Control: Classic/TextInput
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.Reason.Label'.Y + 'LeaveRequest.Reason.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.12
                                    Mode: =TextMode.MultiLine
                                    HintText: ="Nhập lý do nghỉ phép (bắt buộc)"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    OnChange: |
                                      =Set(varLeaveReason, Self.Text)

                              # Handover Content
                              - 'LeaveRequest.HandoverContent.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.Reason.Input'.Y + 'LeaveRequest.Reason.Input'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.06
                                    Text: ="Nội dung bàn giao công việc"
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Medium
                                    
                              - 'LeaveRequest.HandoverContent.Input':
                                  Control: Classic/TextInput
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.HandoverContent.Label'.Y + 'LeaveRequest.HandoverContent.Label'.Height + Parent.Height * 0.01
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.12
                                    Mode: =TextMode.MultiLine
                                    HintText: ="Mô tả công việc cần bàn giao (tùy chọn)"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(209, 213, 219, 1)
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    OnChange: |
                                      =Set(varHandoverContent, Self.Text)

                              # Validation & Warning Messages
                              - 'LeaveRequest.Validation.Container':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =0
                                    Y: ='LeaveRequest.HandoverContent.Input'.Y + 'LeaveRequest.HandoverContent.Input'.Height + Parent.Height * 0.03
                                    Width: =Parent.Width
                                    Height: =Parent.Height * 0.2
                                  Children:
                                    - 'LeaveRequest.Validation.Title':
                                        Control: Label
                                        Properties:
                                          X: =0
                                          Y: =0
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.2
                                          Text: ="Kiểm tra điều kiện"
                                          Color: =RGBA(17, 24, 39, 1)
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =FontSizes.Medium
                                          
                                    - 'LeaveRequest.Validation.AdvanceDays':
                                        Control: Label
                                        Properties:
                                          X: =0
                                          Y: =Parent.Height * 0.25
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.25
                                          Text: =If(
                                            And(Not(IsBlank(varSelectedFromDate)), Not(IsBlank(varCalculatedDays))),
                                            With(
                                              DateDiff(Today(), varSelectedFromDate),
                                              If(
                                                And(varCalculatedDays >= 0.5, varCalculatedDays <= 2, ThisRecord < 1),
                                                "! Nghỉ 0.5-2 ngày cần tạo trước 1 ngày",
                                                If(
                                                  And(varCalculatedDays >= 3, varCalculatedDays <= 4, ThisRecord < 7),
                                                  "! Nghỉ 3-4 ngày cần tạo trước 7 ngày",
                                                  If(
                                                    And(varCalculatedDays >= 5, ThisRecord < 14),
                                                    "! Nghỉ từ 5 ngày cần tạo trước 14 ngày",
                                                    "OK! Thời gian tạo đơn hợp lệ"
                                                  )
                                                )
                                              )
                                            ),
                                            " "
                                            )
                                          Color: |
                                            =If(StartsWith(Self.Text, "!"), RGBA(251, 146, 60, 1), RGBA(34, 197, 94, 1))
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Small
                                          Wrap: =true
                                          
                                    - 'LeaveRequest.Validation.Balance':
                                        Control: Label
                                        Properties:
                                          X: =0
                                          Y: =Parent.Height * 0.55
                                          Width: =Parent.Width
                                          Height: =Parent.Height * 0.2
                                          Text: =If(
                                            And(Not(IsBlank(varUserLeaveBalance)), Not(IsBlank(varCalculatedDays))),
                                            If(
                                              varCalculatedDays <= varUserLeaveBalance.SoNgayConLai,
                                              "OK! Số ngày nghỉ trong hạn mức",
                                              Concatenate("! Vượt hạn mức ", varCalculatedDays - varUserLeaveBalance.SoNgayConLai, " ngày (nghỉ không lương)")
                                            ),
                                            ""
                                            )
                                          Color: |
                                            =If(StartsWith(Self.Text, "!"), RGBA(251, 146, 60, 1), RGBA(34, 197, 94, 1))
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Small
                                          Wrap: =true

                        # Submit Actions Container - di chuyển ra cùng level với LeftColumn và RightColumn
                        - 'LeaveRequest.Actions.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.025
                              Y: =Parent.Height * 0.78
                              Width: =Parent.Width * 0.95
                              Height: =Parent.Height * 0.15
                            Children:
                              - 'LeaveRequest.Submit.Button':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =0
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.48
                                    Height: =Parent.Height * 0.7
                                    Text: =If(varIsSubmitting, "Đang gửi...", "Gửi đơn")
                                    Size: ="Medium"
                                    IsDisabled: =Or(
                                      varIsSubmitting,
                                      IsBlank(varSelectedLeaveType),
                                      IsBlank(varSelectedFromDate),
                                      IsBlank(varSelectedToDate),
                                      IsBlank(varLeaveReason),
                                      varCalculatedDays <= 0
                                      )
                                    OnClick: |
                                      =Set(varIsSubmitting, true);
                                      With(
                                        {
                                          NewLeaveRequest: {
                                            MaNguoiDung: {Value: UserSession.Id},
                                            NgayBatDau: varSelectedFromDate,
                                            NgayKetThuc: varSelectedToDate,
                                            SoNgayNghi: varCalculatedDays,
                                            MaLoai: {Value: varSelectedLeaveType.MaLoai},
                                            LyDo: varLeaveReason,
                                            NguoiBanGiao: If(Not(IsBlank(varHandoverPerson)), {Value: varHandoverPerson.Title}, Blank()),
                                            NoiDungBanGiao: varHandoverContent,
                                            TrangThai: {Value: "ChoDuyetCap1"},
                                            BuoiNghi: {Value: "CaNgay"},
                                            NguoiTao: {Value: UserSession.Id},
                                            ThoiHanPheDuyet: DateAdd(Today(), 1, Days),
                                            UuTien: {Value: "BinhThuong"},
                                            MaDon: GUID()
                                          }
                                        },
                                        Patch(DonNghiPhep, Defaults(DonNghiPhep), NewLeaveRequest);
                                        Set(varIsSubmitting, false);
                                        Set(varShowSuccessModal, true);
                                        Notify("Đã gửi đơn nghỉ phép thành công!", NotificationType.Success)
                                      )
                                            
                              - 'LeaveRequest.Reset.Button':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.52
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.48
                                    Height: =Parent.Height * 0.7
                                    Text: ="Làm mới"
                                    Size: ="Medium"
                                    OnClick: |
                                      =Set(varSelectedFromDate, Blank());
                                      Set(varSelectedToDate, Blank());
                                      Set(varSelectedLeaveType, Blank());
                                      Set(varLeaveReason, "");
                                      Set(varHandoverPerson, Blank());
                                      Set(varHandoverContent, "");
                                      Set(varCalculatedDays, 0);
                                      Reset('LeaveRequest.LeaveType.Dropdown');
                                      Reset('LeaveRequest.FromDate.DatePicker');
                                      Reset('LeaveRequest.ToDate.DatePicker');
                                      Reset('LeaveRequest.Reason.Input');
                                      Reset('LeaveRequest.HandoverContent.Input');
                                      Reset('LeaveRequest.Handover.Dropdown')

      # Success Modal
      - 'LeaveRequest.Success.Modal':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =(Parent.Width - Parent.Width * 0.5) / 2
            Y: =(Parent.Height - Parent.Height * 0.4) / 2
            Width: =Parent.Width * 0.5
            Height: =Parent.Height * 0.4
            Fill: =RGBA(255, 255, 255, 1)
            BorderColor: =RGBA(226, 232, 240, 1)
            BorderThickness: =2
            Visible: =varShowSuccessModal
          Children:
            - 'LeaveRequest.Success.Header':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.04
                  Y: =Parent.Height * 0.04
                  Width: =Parent.Width * 0.92
                  Height: =Parent.Height * 0.2
                  Fill: =RGBA(34, 197, 94, 1)
                  BorderColor: =RGBA(21, 128, 61, 1)
                  BorderThickness: =1
                Children:
                  - 'LeaveRequest.Success.Icon':
                      Control: Classic/Icon
                      Properties:
                        X: =Parent.Width * 0.05
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Height * 0.6
                        Height: =Parent.Height * 0.6
                        Icon: =Icon.CheckBadge
                        Color: =RGBA(255, 255, 255, 1)
                        
            - 'LeaveRequest.Success.Title':
                Control: Label
                Properties:
                  X: =Parent.Width * 0.2
                  Y: ='LeaveRequest.Success.Header'.Y + ('LeaveRequest.Success.Header'.Height - Self.Height) / 2
                  Width: =Parent.Width * 0.75
                  Height: =Parent.Height * 0.08
                  Text: ="Gửi đơn thành công!"
                  Color: =RGBA(255, 255, 255, 1)
                  Font: =Font.'Open Sans'
                  FontWeight: =FontWeight.Bold
                  Size: =FontSizes.Medium
                  
            - 'LeaveRequest.Success.Content':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.04
                  Y: ='LeaveRequest.Success.Header'.Y + 'LeaveRequest.Success.Header'.Height + Parent.Height * 0.03
                  Width: =Parent.Width * 0.92
                  Height: =Parent.Height * 0.45
                Children:
                  - 'LeaveRequest.Success.Message':
                      Control: Label
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height
                        Text: =Concatenate("Đơn nghỉ phép từ ngày ", Text(varSelectedFromDate, "dd/mm/yyyy"), " đến ", Text(varSelectedToDate, "dd/mm/yyyy"), " đã được gửi thành công.", Char(10), Char(10), "Đơn sẽ được chuyển đến người phê duyệt trong vòng 24 giờ.")
                        Color: =RGBA(55, 65, 81, 1)
                        Font: =Font.'Open Sans'
                        Size: =Parent.Height * 0.12
                        Align: =Align.Center
                        Wrap: =true
                  
            - 'LeaveRequest.Success.Actions':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.04
                  Y: ='LeaveRequest.Success.Content'.Y + 'LeaveRequest.Success.Content'.Height + Parent.Height * 0.03
                  Width: =Parent.Width * 0.92
                  Height: =Parent.Height * 0.2
                Children:
                  - 'LeaveRequest.Success.CreateNewButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =0
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.45
                        Height: =Parent.Height * 0.8
                        Text: ="Tạo đơn mới"
                        Size: ="Medium"
                        OnClick: |
                          =Set(varShowSuccessModal, false);
                          Set(varSelectedFromDate, Blank());
                          Set(varSelectedToDate, Blank());
                          Set(varSelectedLeaveType, Blank());
                          Set(varLeaveReason, "");
                          Set(varHandoverPerson, Blank());
                          Set(varHandoverContent, "");
                          Set(varCalculatedDays, 0);
                          Reset('LeaveRequest.LeaveType.Dropdown');
                          Reset('LeaveRequest.FromDate.DatePicker');
                          Reset('LeaveRequest.ToDate.DatePicker');
                          Reset('LeaveRequest.Reason.Input');
                          Reset('LeaveRequest.HandoverContent.Input');
                          Reset('LeaveRequest.Handover.Dropdown')
                        
                  - 'LeaveRequest.Success.ViewMyLeavesButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width * 0.55
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.45
                        Height: =Parent.Height * 0.8
                        Text: ="Xem đơn của tôi"
                        Size: ="Medium"
                        OnClick: |
                          =Set(varShowSuccessModal, false);
                          Navigate(MyLeavesScreen) 
