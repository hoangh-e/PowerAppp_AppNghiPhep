Screens:
  CalendarScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =Set(varActiveScreen, "Calendar");
        Set(varNetworkError, false);
        Set(varDataLoading, true);
        Set(varCurrentDate, Today());
        Set(varSelectedMonth, Month(Today()));
        Set(varSelectedYear, Year(Today()));
        Set(varCalendarView, "Personal");
        Set(varViewFormat, "Calendar");
        Set(varShowCalendarDetails, false);
        Set(varSelectedDateLeaves, Blank());
        
        //Check user permissions using helper functions from App/Formulas
        Set(varUserPermissions, {
          CanViewPersonalLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.PERSONAL_LEAVE),
          CanCreateSpecialLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.SPECIAL_LEAVE),
          CanViewTeamLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.VIEW_TEAM_LEAVE),
          CanViewAllLeaves: CheckPermission(UserSessionANP.Permission, UserPermissions.VIEW_ALL_LEAVE),
          CanApproveLevel1: CheckPermission(UserSessionANP.Permission, UserPermissions.APPROVE_LEVEL_1),
          CanApproveLevel2: CheckPermission(UserSessionANP.Permission, UserPermissions.APPROVE_LEVEL_2),
          CanApproveLevel3: CheckPermission(UserSessionANP.Permission, UserPermissions.APPROVE_LEVEL_3),
          CanRecordLeave: CheckPermission(UserSessionANP.Permission, UserPermissions.RECORD_LEAVE),
          CanManageUsers: CheckPermission(UserSessionANP.Permission, UserPermissions.MANAGE_USERS),
          CanExportReports: CheckPermission(UserSessionANP.Permission, UserPermissions.EXPORT_REPORTS),
          UserPermissionLevel: GetUserPermissionLevel(UserSessionANP.Permission),
          CanAccessManagement: CanAccessManagement(UserSessionANP.Permission)
        });
        
        //CRITICAL: Check if user has calendar viewing permissions
        Set(varCanViewCalendar, Or(varUserPermissions.CanViewPersonalLeaves, varUserPermissions.CanViewTeamLeaves, varUserPermissions.CanViewAllLeaves));
        
        //If no calendar permission, redirect to Dashboard with notification
        If(Not(varCanViewCalendar),
          Notify("Bạn không có quyền xem lịch nghỉ phép", NotificationType.Error);
          Navigate(DashboardScreen),
          //Continue with calendar screen initialization
          // Load SharePoint data with fallback to demo data
          If(IsEmpty(NguoiDung),
            Set(UserSessionANP, {
              Id: "EMP001", 
              HoTen: "Nguyễn Văn An", 
              Email: "an.nguyen@company.com", 
              MaVaiTro: "Employee", 
              Permission: 7,
              NguoiQuanLyId: "MGR001",
              ChucDanh: "Nhân viên", 
              MaDonVi: "IT", 
              TrangThai: "HoatDong",
              Name: "Nguyễn Văn An",
              Role: "Employee"
            });
            Set(varNetworkError, true);
            // Create demo leave data for preview
            ClearCollect(colPersonalLeaves, 
              Table(
                {MaNguoiDung: {Value: "EMP001"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 5), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 7), SoNgayNghi: 3, MaLoai: {Value: "ANNUAL"}, LyDo: "Nghỉ phép năm", TrangThai: {Value: "DaDuyet"}},
                {MaNguoiDung: {Value: "EMP001"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 15), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 15), SoNgayNghi: 1, MaLoai: {Value: "SICK"}, LyDo: "Nghỉ ốm", TrangThai: {Value: "ChoDuyetCap1"}}
              )
            );
            ClearCollect(colDepartmentLeaves,
              Table(
                {MaNguoiDung: {Value: "EMP002"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 10), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 12), SoNgayNghi: 3, MaLoai: {Value: "ANNUAL"}, LyDo: "Nghỉ phép", TrangThai: {Value: "DaDuyet"}},
                {MaNguoiDung: {Value: "EMP003"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 20), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 22), SoNgayNghi: 3, MaLoai: {Value: "PERSONAL"}, LyDo: "Việc cá nhân", TrangThai: {Value: "DaDuyet"}}
              )
            );
            ClearCollect(colAllLeaves,
              Table(
                {MaNguoiDung: {Value: "EMP001"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 5), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 7), SoNgayNghi: 3, MaLoai: {Value: "ANNUAL"}, LyDo: "Nghỉ phép năm", TrangThai: {Value: "DaDuyet"}},
                {MaNguoiDung: {Value: "EMP002"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 10), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 12), SoNgayNghi: 3, MaLoai: {Value: "ANNUAL"}, LyDo: "Nghỉ phép", TrangThai: {Value: "DaDuyet"}},
                {MaNguoiDung: {Value: "EMP003"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 20), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 22), SoNgayNghi: 3, MaLoai: {Value: "PERSONAL"}, LyDo: "Việc cá nhân", TrangThai: {Value: "DaDuyet"}},
                {MaNguoiDung: {Value: "EMP001"}, NgayBatDau: Date(varSelectedYear, varSelectedMonth, 15), NgayKetThuc: Date(varSelectedYear, varSelectedMonth, 15), SoNgayNghi: 1, MaLoai: {Value: "SICK"}, LyDo: "Nghỉ ốm", TrangThai: {Value: "ChoDuyetCap1"}}
              )
            );
            // Demo holidays
            ClearCollect(colHolidays,
              Table(
                {Ngay: "01/01", TenNgayLe: "Tết Dương lịch", FormattedDate: Text(Date(varSelectedYear, 1, 1), "yyyy-mm-dd")},
                {Ngay: "30/04", TenNgayLe: "Giải phóng miền Nam", FormattedDate: Text(Date(varSelectedYear, 4, 30), "yyyy-mm-dd")},
                {Ngay: "01/05", TenNgayLe: "Quốc tế Lao động", FormattedDate: Text(Date(varSelectedYear, 5, 1), "yyyy-mm-dd")},
                {Ngay: "02/09", TenNgayLe: "Quốc khánh", FormattedDate: Text(Date(varSelectedYear, 9, 2), "yyyy-mm-dd")}
              )
            );
            // Demo users for lookups
            ClearCollect(colCalendarUsers,
              Table(
                {Title: "EMP001", HoTen: "Nguyễn Văn An", MaDonVi: {Value: "IT"}},
                {Title: "EMP002", HoTen: "Trần Thị Bình", MaDonVi: {Value: "IT"}},
                {Title: "EMP003", HoTen: "Lê Văn Cường", MaDonVi: {Value: "IT"}}
              )
            );
            // Demo leave types
            ClearCollect(colCalendarLeaveTypes,
              Table(
                {Title: "ANNUAL", TenLoai: "Nghỉ phép năm"},
                {Title: "SICK", TenLoai: "Nghỉ ốm"},
                {Title: "PERSONAL", TenLoai: "Việc cá nhân"}
              )
            ),
            // Use actual SharePoint user data - ensure structure consistency
            With(
              {userRecord: LookUp(NguoiDung, Email = User().Email)},
              Set(UserSessionANP, {
                Id: userRecord.Title,
                HoTen: userRecord.HoTen,
                Email: userRecord.Email,
                MaVaiTro: userRecord.MaVaiTro,
                Permission: userRecord.Permission,
                NguoiQuanLyId: If(IsBlank(userRecord.MaQuanLy), "", Text(userRecord.MaQuanLy.Value)),
                ChucDanh: Text(userRecord.ChucDanh.Value),
                MaDonVi: Text(userRecord.MaDonVi.Value),
                TrangThai: Text(userRecord.TrangThai.Value),
                Name: userRecord.HoTen,
                Role: userRecord.MaVaiTro
              })
            );
            Set(varNetworkError, false);
            // Load Personal Leaves from SharePoint
            ClearCollect(colPersonalLeaves, 
              Filter(DonNghiPhep, 
                And(
                  MaNguoiDung.Value = UserSessionANP.Id,
                  Or(
                    Month(NgayBatDau) = varSelectedMonth,
                    Month(NgayKetThuc) = varSelectedMonth,
                    And(NgayBatDau <= Date(varSelectedYear, varSelectedMonth, 1), NgayKetThuc >= DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days))
                  )
                )
              )
            );
            // Load Department Leaves from SharePoint
            ClearCollect(colDepartmentLeaves,
              Filter(DonNghiPhep,
                And(
                  LookUp(NguoiDung, Title = MaNguoiDung.Value).MaDonVi.Value = UserSessionANP.MaDonVi,
                  Or(
                    Month(NgayBatDau) = varSelectedMonth,
                    Month(NgayKetThuc) = varSelectedMonth,
                    And(NgayBatDau <= Date(varSelectedYear, varSelectedMonth, 1), NgayKetThuc >= DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days))
                  )
                )
              )
            );
            // Load All Company Leaves from SharePoint
            ClearCollect(colAllLeaves,
              Filter(DonNghiPhep,
                Or(
                  Month(NgayBatDau) = varSelectedMonth,
                  Month(NgayKetThuc) = varSelectedMonth,
                  And(NgayBatDau <= Date(varSelectedYear, varSelectedMonth, 1), NgayKetThuc >= DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days))
                )
              )
            );
            // Load Holidays from SharePoint
            ClearCollect(colHolidays,
              ForAll(
                Filter(NgayLe, Nam = varSelectedYear),
                {
                  Ngay: Ngay,
                  TenNgayLe: TenNgayLe,
                  FormattedDate: Text(DateValue(Ngay & "/" & varSelectedYear), "yyyy-mm-dd")
                }
              )
            );
            // Load Users from SharePoint for lookups
            ClearCollect(colCalendarUsers, NguoiDung);
            // Load Leave Types from SharePoint
            ClearCollect(colCalendarLeaveTypes, LoaiNghi)
          );
          Set(varFirstDayOfMonth, Date(varSelectedYear, varSelectedMonth, 1));
          Set(varLastDayOfMonth, DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days));
          Set(varFirstWeekday, Weekday(varFirstDayOfMonth, StartOfWeek.Sunday));
          Set(varDaysInMonth, Day(varLastDayOfMonth));
          Set(varStartDate, DateAdd(varFirstDayOfMonth, -(varFirstWeekday - 1), TimeUnit.Days));
          // Tính số tuần cần thiết: đảm bảo mỗi tuần có ít nhất 1 ngày của tháng
          Set(varWeeksNeeded, Max(RoundUp((varDaysInMonth + varFirstWeekday - 1) / 7, 0), 1));
          Set(varTotalCells, varWeeksNeeded * 7);
          ClearCollect(colCalendarDays,
            ForAll(
              Sequence(varTotalCells),
              With(
                {currentDate: DateAdd(varStartDate, Value - 1, TimeUnit.Days)},
                {
                  CalendarDate: currentDate,
                  IsCurrentMonth: Month(currentDate) = varSelectedMonth,
                  IsToday: currentDate = Today(),
                  IsWeekend: Or(Weekday(currentDate, StartOfWeek.Sunday) = 1, Weekday(currentDate, StartOfWeek.Sunday) = 7),
                  DayNumber: Day(currentDate),
                  FormattedDate: Text(currentDate, "yyyy-mm-dd"),
                  WeekRow: RoundUp(Value / 7, 0)
                }
              )
            )
          );
          Set(varDataLoading, false);
          Set(varNetworkError, false)
        )
    Children:
      # Header Component
      - 'Calendar.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =UserSessionANP.HoTen
            UserRole: =UserSessionANP.MaVaiTro
            ShowNotification: =true
            NotificationCount: =0
            OnLogout: |
              =Set(varIsUserAuthenticated, false);
              Navigate(LoginScreen)

      # Navigation Component
      - 'Calendar.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='Calendar.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.045, App.Width * 0.14)
            Height: =Parent.Height - 'Calendar.Header'.Height
            UserRole: =UserSessionANP.MaVaiTro
            ActiveScreen: ="Calendar"
            IsCollapsed: =varNavCollapsed
            DashboardScreen: =DashboardScreen
            LeaveRequestScreen: =LeaveRequestScreen
            MyLeavesScreen: =MyLeavesScreen
            CalendarScreen: =CalendarScreen
            ManagementScreen: =ManagementScreen
            ReportsScreen: =ReportsScreen
            ProfileScreen: =ProfileScreen
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen),
                "LeaveRequest", Navigate(LeaveRequestScreen),
                "MyLeaves", Navigate(MyLeavesScreen),
                "Calendar", Navigate(CalendarScreen),
                "Management", Navigate(ManagementScreen),
                "Profile", Navigate(ProfileScreen),
                "Approval", Navigate(ApprovalScreen),
                "Reports", Navigate(ReportsScreen)
              )
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)
              
      # Main Content Container
      - 'Calendar.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='Calendar.Navigation'.Width
            Y: ='Calendar.Header'.Height
            Width: =Parent.Width - 'Calendar.Navigation'.Width
            Height: =Parent.Height - 'Calendar.Header'.Height
          Children:
            - 'Calendar.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.01
                  Y: =Parent.Height * 0.01
                  Width: =Parent.Width * 0.98
                  Height: =Parent.Height * 0.98
                Children:
                  # Page Header with Controls
                  - 'Calendar.PageHeader.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.15
                      Children:
                        - 'Calendar.PageHeader.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        # Calendar Navigation
                        - 'Calendar.Nav.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.4
                              Height: =Parent.Height * 0.8
                            Children:
                              - 'Calendar.Nav.PrevButton':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =0
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.15
                                    Height: =Parent.Height * 0.6
                                    Text: ="‹"
                                    Variant: ="Outline"
                                    Size: =FontSizes.Medium
                                    OnClick: |
                                      =If(varSelectedMonth = 1,
                                        Set(varSelectedMonth, 12); Set(varSelectedYear, varSelectedYear - 1),
                                        Set(varSelectedMonth, varSelectedMonth - 1)
                                      );
                                      Set(varFirstDayOfMonth, Date(varSelectedYear, varSelectedMonth, 1));
                                      Set(varLastDayOfMonth, DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days));
                                      Set(varFirstWeekday, Weekday(varFirstDayOfMonth, StartOfWeek.Sunday));
                                      Set(varDaysInMonth, Day(varLastDayOfMonth));
                                      Set(varStartDate, DateAdd(varFirstDayOfMonth, -(varFirstWeekday - 1), TimeUnit.Days));
                                      Set(varWeeksNeeded, Max(RoundUp((varDaysInMonth + varFirstWeekday - 1) / 7, 0), 1));
                                      Set(varTotalCells, varWeeksNeeded * 7);
                                      ClearCollect(colCalendarDays,
                                        ForAll(
                                          Sequence(varTotalCells),
                                          With(
                                            {currentDate: DateAdd(varStartDate, Value - 1, TimeUnit.Days)},
                                            {
                                              CalendarDate: currentDate,
                                              IsCurrentMonth: Month(currentDate) = varSelectedMonth,
                                              IsToday: currentDate = Today(),
                                              IsWeekend: Or(Weekday(currentDate, StartOfWeek.Sunday) = 1, Weekday(currentDate, StartOfWeek.Sunday) = 7),
                                              DayNumber: Day(currentDate),
                                              FormattedDate: Text(currentDate, "yyyy-mm-dd"),
                                              WeekRow: RoundUp(Value / 7, 0)
                                            }
                                          )
                                        )
                                      )
                                      ClearCollect(colCalendarDays,
                                        ForAll(
                                          Sequence(varTotalCells),
                                          With(
                                            {currentDate: DateAdd(varStartDate, Value - 1, TimeUnit.Days)},
                                            {
                                              CalendarDate: currentDate,
                                              IsCurrentMonth: Month(currentDate) = varSelectedMonth,
                                              IsToday: currentDate = Today(),
                                              IsWeekend: Or(Weekday(currentDate, StartOfWeek.Sunday) = 1, Weekday(currentDate, StartOfWeek.Sunday) = 7),
                                              DayNumber: Day(currentDate),
                                              FormattedDate: Text(currentDate, "yyyy-mm-dd"),
                                              WeekRow: RoundUp(Value / 7, 0)
                                            }
                                          )
                                        )
                                      )
                                      
                              - 'Calendar.Nav.MonthYear':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.2
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.6
                                    Height: =Parent.Height * 0.6
                                    Text: =Concatenate("Tháng ", varSelectedMonth, " năm ", varSelectedYear)
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Large
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    
                              - 'Calendar.Nav.NextButton':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.85
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.15
                                    Height: =Parent.Height * 0.6
                                    Text: ="›"
                                    Variant: ="Outline"
                                    Size: =FontSizes.Medium
                                    OnClick: |
                                      =If(varSelectedMonth = 12,
                                        Set(varSelectedMonth, 1); Set(varSelectedYear, varSelectedYear + 1),
                                        Set(varSelectedMonth, varSelectedMonth + 1)
                                      );
                                      Set(varFirstDayOfMonth, Date(varSelectedYear, varSelectedMonth, 1));
                                      Set(varLastDayOfMonth, DateAdd(Date(varSelectedYear, varSelectedMonth + 1, 1), -1, TimeUnit.Days));
                                      Set(varFirstWeekday, Weekday(varFirstDayOfMonth, StartOfWeek.Sunday));
                                      Set(varDaysInMonth, Day(varLastDayOfMonth));
                                      Set(varStartDate, DateAdd(varFirstDayOfMonth, -(varFirstWeekday - 1), TimeUnit.Days));
                                      Set(varWeeksNeeded, Max(RoundUp((varDaysInMonth + varFirstWeekday - 1) / 7, 0), 1));
                                      Set(varTotalCells, varWeeksNeeded * 7);
                                      ClearCollect(colCalendarDays,
                                        ForAll(
                                          Sequence(varTotalCells),
                                          With(
                                            {currentDate: DateAdd(varStartDate, Value - 1, TimeUnit.Days)},
                                            {
                                              CalendarDate: currentDate,
                                              IsCurrentMonth: Month(currentDate) = varSelectedMonth,
                                              IsToday: currentDate = Today(),
                                              IsWeekend: Or(Weekday(currentDate, StartOfWeek.Sunday) = 1, Weekday(currentDate, StartOfWeek.Sunday) = 7),
                                              DayNumber: Day(currentDate),
                                              FormattedDate: Text(currentDate, "yyyy-mm-dd"),
                                              WeekRow: RoundUp(Value / 7, 0)
                                            }
                                          )
                                        )
                                      )
                                      ClearCollect(colCalendarDays,
                                        ForAll(
                                          Sequence(varTotalCells),
                                          With(
                                            {currentDate: DateAdd(varStartDate, Value - 1, TimeUnit.Days)},
                                            {
                                              CalendarDate: currentDate,
                                              IsCurrentMonth: Month(currentDate) = varSelectedMonth,
                                              IsToday: currentDate = Today(),
                                              IsWeekend: Or(Weekday(currentDate, StartOfWeek.Sunday) = 1, Weekday(currentDate, StartOfWeek.Sunday) = 7),
                                              DayNumber: Day(currentDate),
                                              FormattedDate: Text(currentDate, "yyyy-mm-dd"),
                                              WeekRow: RoundUp(Value / 7, 0)
                                            }
                                          )
                                        )
                                      )
                                      
                        # View Toggle Controls
                        - 'Calendar.ViewToggle.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.45
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.25
                              Height: =Parent.Height * 0.8
                            Children:
                              - 'Calendar.ViewToggle.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.35
                                    Height: =Parent.Height * 0.6
                                    Text: ="Hiển thị:"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base
                                    VerticalAlign: =VerticalAlign.Middle
                                    
                              - 'Calendar.ViewToggle.Personal':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.4
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.6
                                    Text: ="CN"
                                    Variant: =If(varCalendarView = "Personal", "Primary", "Outline")
                                    Size: =FontSizes.Small
                                    OnClick: =Set(varCalendarView, "Personal")
                                    
                              - 'Calendar.ViewToggle.Department':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.62
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.6
                                    Text: ="PB"
                                    Variant: =If(varCalendarView = "Department", "Primary", "Outline")
                                    Size: =FontSizes.Small
                                    OnClick: =Set(varCalendarView, "Department")
                                    
                              - 'Calendar.ViewToggle.All':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.84
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.18
                                    Height: =Parent.Height * 0.6
                                    Text: ="CT"
                                    Variant: =If(varCalendarView = "All", "Primary", "Outline")
                                    Size: =FontSizes.Small
                                    OnClick: =Set(varCalendarView, "All")
                                    
                        # Format Toggle Controls  
                        - 'Calendar.FormatToggle.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.72
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.26
                              Height: =Parent.Height * 0.8
                            Children:
                              - 'Calendar.FormatToggle.Label':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.35
                                    Height: =Parent.Height * 0.6
                                    Text: ="Dạng:"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base
                                    VerticalAlign: =VerticalAlign.Middle
                                    
                              - 'Calendar.FormatToggle.Calendar':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.4
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.28
                                    Height: =Parent.Height * 0.6
                                    Text: ="Lịch"
                                    Variant: =If(varViewFormat = "Calendar", "Primary", "Outline")
                                    Size: =FontSizes.Small
                                    OnClick: =Set(varViewFormat, "Calendar")
                                    
                              - 'Calendar.FormatToggle.List':
                                  Control: CanvasComponent
                                  ComponentName: ButtonComponent
                                  Properties:
                                    X: =Parent.Width * 0.72
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.28
                                    Height: =Parent.Height * 0.6
                                    Text: ="DS"
                                    Variant: =If(varViewFormat = "List", "Primary", "Outline")
                                    Size: =FontSizes.Small
                                    OnClick: =Set(varViewFormat, "List")

                  # Calendar Grid (only show when Calendar format)
                  - 'Calendar.Grid.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Calendar.PageHeader.Container'.Y + 'Calendar.PageHeader.Container'.Height + Parent.Height * 0.01
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.82
                        Visible: =varViewFormat = "Calendar"
                      Children:
                        - 'Calendar.Grid.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        # Week Days Header
                        - 'Calendar.WeekDays.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.02
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.1
                            Children:
                              - 'Calendar.WeekDays.Sunday':
                                  Control: Label
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="CN"
                                    Color: =RGBA(239, 68, 68, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Monday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T2"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Tuesday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7 * 2
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T3"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Wednesday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7 * 3
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T4"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Thursday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7 * 4
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T5"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Friday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7 * 5
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T6"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                              - 'Calendar.WeekDays.Saturday':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width / 7 * 6
                                    Y: =0
                                    Width: =Parent.Width / 7
                                    Height: =Parent.Height
                                    Text: ="T7"
                                    Color: =RGBA(239, 68, 68, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Bold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    
                        # Calendar Days Grid - Fixed Layout Direction (Left to Right, Top to Bottom)
                        - 'Calendar.Days.Gallery':
                            Control: Gallery
                            Variant: Vertical
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: ='Calendar.WeekDays.Container'.Y + 'Calendar.WeekDays.Container'.Height
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.88
                              Items: =colCalendarDays
                              TemplateSize: =(Parent.Height * 0.88) / Max(varWeeksNeeded, 1)
                              WrapCount: =7
                              BorderThickness: =0
                              Fill: =RGBA(0, 0, 0, 0)
                            Children:
                              # Day Cell Container
                              - 'Calendar.Day.Cell':
                                  Control: Rectangle
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.TemplateWidth
                                    Height: =Parent.TemplateHeight
                                    Fill: =If(
                                      ThisItem.IsToday, RGBA(59, 130, 246, 0.1),
                                      If(Not(ThisItem.IsCurrentMonth), RGBA(249, 250, 251, 1),
                                        If(ThisItem.IsWeekend, RGBA(254, 242, 242, 1), RGBA(255, 255, 255, 1))
                                      ))
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                    OnSelect: |
                                      =Switch(varCalendarView,
                                        "Personal", Set(varSelectedDateLeaves, Filter(colPersonalLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))),
                                        "Department", Set(varSelectedDateLeaves, Filter(colDepartmentLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))),
                                        "All", Set(varSelectedDateLeaves, Filter(colAllLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate)))
                                      );
                                      If(CountRows(varSelectedDateLeaves) > 0,
                                        Set(varShowCalendarDetails, true)
                                      )
                                      
                              # Day Number
                              - 'Calendar.Day.Number':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.05
                                    Y: =Parent.TemplateHeight * 0.05
                                    Width: =Parent.TemplateWidth * 0.4
                                    Height: =Parent.TemplateHeight * 0.4
                                    Text: =ThisItem.DayNumber
                                    Color: =If(
                                      ThisItem.IsToday, RGBA(59, 130, 246, 1),
                                      If(Not(ThisItem.IsCurrentMonth), RGBA(156, 163, 175, 1),
                                        If(ThisItem.IsWeekend, RGBA(239, 68, 68, 1), RGBA(17, 24, 39, 1))
                                      ))
                                    Font: =Font.'Open Sans'
                                    FontWeight: =If(ThisItem.IsToday, FontWeight.Bold, FontWeight.Normal)
                                    Size: =FontSizes.Large
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    
                              - 'Calendar.Day.Holiday':
                                  Control: Classic/Icon
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.7
                                    Y: =Parent.TemplateHeight * 0.05
                                    Width: =Parent.TemplateHeight * 0.25
                                    Height: =Parent.TemplateHeight * 0.25
                                    Icon: =Icon.CalendarBlank
                                    Color: =RGBA(251, 191, 36, 1)
                                    Visible: =CountRows(Filter(colHolidays, FormattedDate = ThisItem.FormattedDate)) > 0
                                    
                              - 'Calendar.Day.PersonalLeave':
                                  Control: Rectangle
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.05
                                    Y: =Parent.TemplateHeight * 0.45
                                    Width: =Parent.TemplateWidth * 0.9
                                    Height: =Parent.TemplateHeight * 0.2
                                    Fill: =RGBA(34, 197, 94, 0.7)
                                    BorderColor: =RGBA(34, 197, 94, 1)
                                    BorderThickness: =1
                                    Visible: =And(
                                      varCalendarView = "Personal",
                                      CountRows(Filter(colPersonalLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))) > 0
                                      )
                                      
                              # Department Leave Count
                              - 'Calendar.Day.DepartmentCount':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.05
                                    Y: =Parent.TemplateHeight * 0.45
                                    Width: =Parent.TemplateWidth * 0.9
                                    Height: =Parent.TemplateHeight * 0.25
                                    Text: =CountRows(Filter(colDepartmentLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))) & " người"
                                    Color: =RGBA(59, 130, 246, 1)
                                    Fill: =RGBA(219, 234, 254, 0.8)
                                    BorderColor: =RGBA(59, 130, 246, 1)
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    Visible: =And(
                                      varCalendarView = "Department",
                                      CountRows(Filter(colDepartmentLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))) > 0
                                      )
                                      
                              # All Company Leave Count
                              - 'Calendar.Day.AllCount':
                                  Control: Label
                                  Properties:
                                    X: =Parent.TemplateWidth * 0.05
                                    Y: =Parent.TemplateHeight * 0.45
                                    Width: =Parent.TemplateWidth * 0.9
                                    Height: =Parent.TemplateHeight * 0.25
                                    Text: =CountRows(Filter(colAllLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))) & " người"
                                    Color: =RGBA(139, 69, 19, 1)
                                    Fill: =RGBA(254, 243, 199, 0.8)
                                    BorderColor: =RGBA(139, 69, 19, 1)
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    VerticalAlign: =VerticalAlign.Middle
                                    Visible: =And(
                                      varCalendarView = "All",
                                      CountRows(Filter(colAllLeaves, And(NgayBatDau <= ThisItem.CalendarDate, NgayKetThuc >= ThisItem.CalendarDate))) > 0
                                      )

                  # List View (only show when List format)
                  - 'Calendar.List.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='Calendar.PageHeader.Container'.Y + 'Calendar.PageHeader.Container'.Height + Parent.Height * 0.01
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.82
                        Visible: =varViewFormat = "List"
                      Children:
                        - 'Calendar.List.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                              
                        # Leave List Gallery for List View
                        - 'Calendar.List.Gallery':
                            Control: Gallery
                            Variant: Vertical
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.02
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.96
                              Items: =Switch(varCalendarView,
                                "Personal", colPersonalLeaves,
                                "Department", colDepartmentLeaves,
                                "All", colAllLeaves
                                )
                              TemplateSize: =80
                              BorderThickness: =0
                              Fill: =RGBA(0, 0, 0, 0)
                            Children:
                              - 'Calendar.List.Item':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.TemplateWidth
                                    Height: =80
                                    Fill: =RGBA(255, 255, 255, 1)
                                    BorderColor: =RGBA(226, 232, 240, 1)
                                    BorderThickness: =1
                                  Children:
                                    # Employee Info
                                    - 'Calendar.List.EmployeeName':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.02
                                          Y: =Parent.Height * 0.1
                                          Width: =Parent.Width * 0.2
                                          Height: =Parent.Height * 0.4
                                          Text: =LookUp(colCalendarUsers, Title = ThisItem.MaNguoiDung.Value).HoTen
                                          Color: =RGBA(17, 24, 39, 1)
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =FontSizes.Base
                                          
                                    - 'Calendar.List.Department':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.02
                                          Y: =Parent.Height * 0.55
                                          Width: =Parent.Width * 0.2
                                          Height: =Parent.Height * 0.35
                                          Text: =LookUp(colCalendarUsers, Title = ThisItem.MaNguoiDung.Value).MaDonVi.Value
                                          Color: =RGBA(75, 85, 99, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Base
                                          
                                    # Leave Details
                                    - 'Calendar.List.Period':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.24
                                          Y: =Parent.Height * 0.1
                                          Width: =Parent.Width * 0.18
                                          Height: =Parent.Height * 0.4
                                          Text: =Text(ThisItem.NgayBatDau, "dd/mm/yyyy") & " - " & Text(ThisItem.NgayKetThuc, "dd/mm/yyyy")
                                          Color: =RGBA(17, 24, 39, 1)
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =FontSizes.Base
                                          
                                    - 'Calendar.List.Days':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.24
                                          Y: =Parent.Height * 0.55
                                          Width: =Parent.Width * 0.18
                                          Height: =Parent.Height * 0.35
                                          Text: =ThisItem.SoNgayNghi & " ngày"
                                          Color: =RGBA(75, 85, 99, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Base
                                          
                                    # Leave Type
                                    - 'Calendar.List.LeaveType':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.44
                                          Y: =Parent.Height * 0.1
                                          Width: =Parent.Width * 0.15
                                          Height: =Parent.Height * 0.8
                                          Text: =LookUp(colCalendarLeaveTypes, Title = ThisItem.MaLoai.Value).TenLoai
                                          Color: =RGBA(17, 24, 39, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Base
                                          
                                    # Status
                                    - 'Calendar.List.Status':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.61
                                          Y: =(Parent.Height - Self.Height) / 2
                                          Width: =Parent.Width * 0.15
                                          Height: =Parent.Height * 0.6
                                          Text: =Switch(ThisItem.TrangThai.Value, 
                                            "ChoDuyetCap1", "Chờ duyệt",
                                            "ChoDuyetCap2", "Chờ duyệt", 
                                            "ChoDuyetCap3", "Chờ duyệt",
                                            "DaDuyet", "Đã duyệt",
                                            "TuChoi", "Từ chối",
                                            "Huy", "Đã hủy",
                                            ThisItem.TrangThai.Value)
                                          Color: =Switch(ThisItem.TrangThai.Value,
                                            "DaDuyet", RGBA(34, 197, 94, 1),
                                            "TuChoi", RGBA(239, 68, 68, 1),
                                            "Huy", RGBA(107, 114, 128, 1),
                                            RGBA(251, 191, 36, 1))
                                          Fill: =Switch(ThisItem.TrangThai.Value,
                                            "DaDuyet", RGBA(240, 253, 244, 1),
                                            "TuChoi", RGBA(254, 242, 242, 1),
                                            "Huy", RGBA(249, 250, 251, 1),
                                            RGBA(254, 243, 199, 1))
                                          BorderColor: =Switch(ThisItem.TrangThai.Value,
                                            "DaDuyet", RGBA(34, 197, 94, 1),
                                            "TuChoi", RGBA(239, 68, 68, 1),
                                            "Huy", RGBA(107, 114, 128, 1),
                                            RGBA(251, 191, 36, 1))
                                          BorderThickness: =1
                                          Font: =Font.'Open Sans'
                                          FontWeight: =FontWeight.Semibold
                                          Size: =FontSizes.Base
                                          Align: =Align.Center
                                          
                                    # Reason
                                    - 'Calendar.List.Reason':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.78
                                          Y: =(Parent.Height - Self.Height) / 2
                                          Width: =Parent.Width * 0.2
                                          Height: =Parent.Height * 0.8
                                          Text: =ThisItem.LyDo
                                          Color: =RGBA(75, 85, 99, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =FontSizes.Base
                                          Wrap: =true

             # Loading Indicator
      - 'Calendar.Loading.Overlay':
          Control: Rectangle
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height
            Fill: =RGBA(255, 255, 255, 0.8)
            Visible: =varDataLoading
           
      - 'Calendar.Loading.Text':
          Control: Label
          Properties:
            X: =(Parent.Width - Self.Width) / 2
            Y: =(Parent.Height - Self.Height) / 2
            Width: =200
            Height: =50
            Text: ="Đang tải dữ liệu..."
            Color: =RGBA(59, 130, 246, 1)
            Font: =Font.'Open Sans'
            FontWeight: =FontWeight.Semibold
            Size: =FontSizes.Large
            Align: =Align.Center
            VerticalAlign: =VerticalAlign.Middle
            Visible: =varDataLoading
             
       # Network Error Message
      - 'Calendar.Error.Message':
          Control: Rectangle
          Properties:
            X: =(Parent.Width - Parent.Width * 0.4) / 2
            Y: =Parent.Height * 0.1
            Width: =Parent.Width * 0.4
            Height: =60
            Fill: =RGBA(254, 242, 242, 1)
            BorderColor: =RGBA(239, 68, 68, 1)
            BorderThickness: =2
            Visible: =varNetworkError
             
      - 'Calendar.Error.Text':
          Control: Label
          Properties:
            X: =(Parent.Width - Parent.Width * 0.38) / 2
            Y: =Parent.Height * 0.1 + 10
            Width: =Parent.Width * 0.38
            Height: =40
            Text: ="Lỗi kết nối SharePoint. Hiển thị dữ liệu demo."
            Color: =RGBA(239, 68, 68, 1)
            Font: =Font.'Open Sans'
            FontWeight: =FontWeight.Semibold
            Size: =FontSizes.Base
            Align: =Align.Center
            VerticalAlign: =VerticalAlign.Middle
            Visible: =varNetworkError

      # Calendar Details Modal
      - 'Calendar.Details.Modal':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =(Parent.Width - Parent.Width * 0.6) / 2
            Y: =(Parent.Height - Parent.Height * 0.7) / 2
            Width: =Parent.Width * 0.6
            Height: =Parent.Height * 0.7
            Fill: =RGBA(255, 255, 255, 1)
            BorderColor: =RGBA(226, 232, 240, 1)
            BorderThickness: =2
            Visible: =varShowCalendarDetails
          Children:
            - 'Calendar.Details.Header':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.02
                  Y: =Parent.Height * 0.02
                  Width: =Parent.Width * 0.96
                  Height: =Parent.Height * 0.08
                  Fill: =RGBA(59, 130, 246, 1)
                  BorderColor: =RGBA(37, 99, 235, 1)
                  BorderThickness: =1
                Children:
                  - 'Calendar.Details.Title':
                      Control: Label
                      Properties:
                        X: =Parent.Width * 0.03
                        Y: =(Parent.Height - Parent.Height * 0.6) / 2
                        Width: =Parent.Width * 0.8
                        Height: =Parent.Height * 0.6
                        Text: ="Chi tiết lịch nghỉ phép"
                        Color: =RGBA(255, 255, 255, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =FontSizes.Large
                        
                  - 'Calendar.Details.CloseButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width * 0.84
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.13
                        Height: =Parent.Height * 0.6
                        Text: ="Đóng"
                        Variant: ="Outline"
                        Size: =FontSizes.Small
                        OnClick: =Set(varShowCalendarDetails, false)
                        
            - 'Calendar.Details.Content':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.02
                  Y: ='Calendar.Details.Header'.Y + 'Calendar.Details.Header'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.96
                  Height: =Parent.Height * 0.86
                  BorderColor: =RGBA(226, 232, 240, 1)
                  BorderThickness: =1
                  Fill: =RGBA(255, 255, 255, 1)
                Children:
                  # Leave List Gallery
                  - 'Calendar.Details.LeaveList':
                      Control: Gallery
                      Variant: Vertical
                      Properties:
                        X: =Parent.Width * 0.02
                        Y: =Parent.Height * 0.02
                        Width: =Parent.Width * 0.96
                        Height: =Parent.Height * 0.96
                        Items: =varSelectedDateLeaves
                        TemplateSize: =80
                        BorderThickness: =0
                        Fill: =RGBA(0, 0, 0, 0)
                      Children:
                        - 'Calendar.Details.LeaveItem':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.TemplateWidth
                              Height: =80
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(226, 232, 240, 1)
                              BorderThickness: =1
                            Children:
                              # Employee Name
                              - 'Calendar.Details.EmployeeName':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.1
                                    Width: =Parent.Width * 0.25
                                    Height: =Parent.Height * 0.4
                                    Text: =LookUp(colCalendarUsers, Title = ThisItem.MaNguoiDung.Value).HoTen
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base
                                    
                              # Leave Period
                              - 'Calendar.Details.LeavePeriod':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.55
                                    Width: =Parent.Width * 0.25
                                    Height: =Parent.Height * 0.35
                                    Text: =Text(ThisItem.NgayBatDau, "dd/mm") & " - " & Text(ThisItem.NgayKetThuc, "dd/mm")
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    
                              # Leave Type
                              - 'Calendar.Details.LeaveType':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.3
                                    Y: =Parent.Height * 0.1
                                    Width: =Parent.Width * 0.2
                                    Height: =Parent.Height * 0.4
                                    Text: =LookUp(colCalendarLeaveTypes, Title = ThisItem.MaLoai.Value).TenLoai
                                    Color: =RGBA(17, 24, 39, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    
                              # Days Count
                              - 'Calendar.Details.DaysCount':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.3
                                    Y: =Parent.Height * 0.55
                                    Width: =Parent.Width * 0.2
                                    Height: =Parent.Height * 0.35
                                    Text: =ThisItem.SoNgayNghi & " ngày"
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    
                              # Status
                              - 'Calendar.Details.Status':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.55
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.2
                                    Height: =Parent.Height * 0.6
                                    Text: =Switch(ThisItem.TrangThai.Value, 
                                      "ChoDuyetCap1", "Chờ duyệt",
                                      "ChoDuyetCap2", "Chờ duyệt", 
                                      "ChoDuyetCap3", "Chờ duyệt",
                                      "DaDuyet", "Đã duyệt",
                                      "TuChoi", "Từ chối",
                                      "Huy", "Đã hủy",
                                      ThisItem.TrangThai.Value)
                                    Color: =Switch(ThisItem.TrangThai.Value,
                                      "DaDuyet", RGBA(34, 197, 94, 1),
                                      "TuChoi", RGBA(239, 68, 68, 1),
                                      "Huy", RGBA(107, 114, 128, 1),
                                      RGBA(251, 191, 36, 1))
                                    Fill: =Switch(ThisItem.TrangThai.Value,
                                      "DaDuyet", RGBA(240, 253, 244, 1),
                                      "TuChoi", RGBA(254, 242, 242, 1),
                                      "Huy", RGBA(249, 250, 251, 1),
                                      RGBA(254, 243, 199, 1))
                                    BorderColor: =Switch(ThisItem.TrangThai.Value,
                                      "DaDuyet", RGBA(34, 197, 94, 1),
                                      "TuChoi", RGBA(239, 68, 68, 1),
                                      "Huy", RGBA(107, 114, 128, 1),
                                      RGBA(251, 191, 36, 1))
                                    BorderThickness: =1
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =FontSizes.Base
                                    Align: =Align.Center
                                    
                              # Reason (partial)
                              - 'Calendar.Details.Reason':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.78
                                    Y: =(Parent.Height - Self.Height) / 2
                                    Width: =Parent.Width * 0.2
                                    Height: =Parent.Height * 0.8
                                    Text: =If(Len(ThisItem.LyDo) > 20, Left(ThisItem.LyDo, 17) & "...", ThisItem.LyDo)
                                    Color: =RGBA(75, 85, 99, 1)
                                    Font: =Font.'Open Sans'
                                    Size: =FontSizes.Base
                                    Wrap: =true 

                  # No data message
                  - 'Calendar.Details.NoData':
                      Control: Label
                      Properties:
                        X: =0
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.2
                        Text: ="Không có dữ liệu nghỉ phép cho ngày này"
                        Color: =RGBA(107, 114, 128, 1)
                        Font: =Font.'Open Sans'
                        Size: =FontSizes.Base
                        Align: =Align.Center
                        VerticalAlign: =VerticalAlign.Middle
                        Visible: =CountRows(varSelectedDateLeaves) = 0

      # List View (only show when List format)
      - 'Calendar.ListView.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: =0
            Y: ='Calendar.PageHeader.Container'.Y + 'Calendar.PageHeader.Container'.Height + Parent.Height * 0.01
            Width: =Parent.Width
            Height: =Parent.Height * 0.82
            Visible: =varViewFormat = "List"
          Children:
            - 'Calendar.ListView.Background':
                Control: Rectangle
                Properties:
                  X: =0
                  Y: =0
                  Width: =Parent.Width
                  Height: =Parent.Height
                  Fill: =RGBA(255, 255, 255, 1)
                  BorderColor: =RGBA(226, 232, 240, 1)
                  BorderThickness: =1
                  
            - 'Calendar.ListView.Gallery':
                Control: Gallery
                Variant: Vertical
                Properties:
                  X: =Parent.Width * 0.02
                  Y: =Parent.Height * 0.02
                  Width: =Parent.Width * 0.96
                  Height: =Parent.Height * 0.94
                  Items: =Switch(varCalendarView,
                    "Personal", colPersonalLeaves,
                    "Department", colDepartmentLeaves,
                    "All", colAllLeaves,
                    colPersonalLeaves)
                  TemplateSize: =120
                  BorderThickness: =0
                  Fill: =RGBA(0, 0, 0, 0)
                Children:
                  - 'Calendar.ListView.Item':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.TemplateWidth
                        Height: =120
                        Fill: =RGBA(255, 255, 255, 1)
                        BorderColor: =RGBA(226, 232, 240, 1)
                        BorderThickness: =1
                      Children:
                        # Employee Info
                        - 'Calendar.ListView.EmployeeName':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.3
                              Height: =Parent.Height * 0.3
                              Text: =LookUp(colCalendarUsers, Title = ThisItem.MaNguoiDung.Value).HoTen
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Bold
                              Size: =FontSizes.Medium
                              
                        - 'Calendar.ListView.Department':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.4
                              Width: =Parent.Width * 0.3
                              Height: =Parent.Height * 0.25
                              Text: =LookUp(colCalendarDepartments, Title = LookUp(colCalendarUsers, Title = ThisItem.MaNguoiDung.Value).MaDonVi.Value).TenDonVi
                              Color: =RGBA(75, 85, 99, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Base
                              
                        # Leave Period
                        - 'Calendar.ListView.Period':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.35
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.25
                              Height: =Parent.Height * 0.3
                              Text: =Text(ThisItem.NgayBatDau, "dd/mm/yyyy") & " - " & Text(ThisItem.NgayKetThuc, "dd/mm/yyyy")
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =FontSizes.Base
                              
                        - 'Calendar.ListView.Days':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.35
                              Y: =Parent.Height * 0.4
                              Width: =Parent.Width * 0.25
                              Height: =Parent.Height * 0.25
                              Text: =ThisItem.SoNgayNghi & " ngày"
                              Color: =RGBA(75, 85, 99, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Base
                              
                        # Leave Type
                        - 'Calendar.ListView.LeaveType':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.63
                              Y: =Parent.Height * 0.05
                              Width: =Parent.Width * 0.17
                              Height: =Parent.Height * 0.3
                              Text: =LookUp(colCalendarLeaveTypes, Title = ThisItem.MaLoai.Value).TenLoai
                              Color: =RGBA(17, 24, 39, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Base
                              
                        # Status
                        - 'Calendar.ListView.Status':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.82
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.16
                              Height: =Parent.Height * 0.4
                              Text: =Switch(ThisItem.TrangThai.Value, 
                                "ChoDuyetCap1", "Chờ duyệt",
                                "ChoDuyetCap2", "Chờ duyệt", 
                                "ChoDuyetCap3", "Chờ duyệt",
                                "DaDuyet", "Đã duyệt",
                                "TuChoi", "Từ chối",
                                "Huy", "Đã hủy",
                                ThisItem.TrangThai.Value)
                              Color: =Switch(ThisItem.TrangThai.Value,
                                "DaDuyet", RGBA(34, 197, 94, 1),
                                "TuChoi", RGBA(239, 68, 68, 1),
                                "Huy", RGBA(107, 114, 128, 1),
                                RGBA(251, 191, 36, 1))
                              Fill: =Switch(ThisItem.TrangThai.Value,
                                "DaDuyet", RGBA(240, 253, 244, 1),
                                "TuChoi", RGBA(254, 242, 242, 1),
                                "Huy", RGBA(249, 250, 251, 1),
                                RGBA(254, 243, 199, 1))
                              BorderColor: =Switch(ThisItem.TrangThai.Value,
                                "DaDuyet", RGBA(34, 197, 94, 1),
                                "TuChoi", RGBA(239, 68, 68, 1),
                                "Huy", RGBA(107, 114, 128, 1),
                                RGBA(251, 191, 36, 1))
                              BorderThickness: =1
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =FontSizes.Small
                              Align: =Align.Center
                              VerticalAlign: =VerticalAlign.Middle
                              
                        # Reason
                        - 'Calendar.ListView.Reason':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.35
                              Y: =Parent.Height * 0.7
                              Width: =Parent.Width * 0.63
                              Height: =Parent.Height * 0.25
                              Text: =If(Len(ThisItem.LyDo) > 50, Left(ThisItem.LyDo, 47) & "...", ThisItem.LyDo)
                              Color: =RGBA(75, 85, 99, 1)
                              Font: =Font.'Open Sans'
                              Size: =FontSizes.Small
                              Wrap: =true
                              
            # No data for List View
            - 'Calendar.ListView.NoData':
                Control: Label
                Properties:
                  X: =0
                  Y: =(Parent.Height - Self.Height) / 2
                  Width: =Parent.Width
                  Height: =Parent.Height * 0.2
                  Text: ="Không có dữ liệu nghỉ phép trong tháng này"
                  Color: =RGBA(107, 114, 128, 1)
                  Font: =Font.'Open Sans'
                  Size: =FontSizes.Large
                  Align: =Align.Center
                  VerticalAlign: =VerticalAlign.Middle
                  Visible: =CountRows(Switch(varCalendarView,
                    "Personal", colPersonalLeaves,
                    "Department", colDepartmentLeaves,
                    "All", colAllLeaves,
                    colPersonalLeaves)) = 0 
