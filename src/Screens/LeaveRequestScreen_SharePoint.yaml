Screens:
  LeaveRequestScreen:
    Properties:
      Fill: =RGBA(248, 250, 252, 1)
      OnVisible: |
        =Set(varActiveScreen, "LeaveRequest"); 
        If(Not(IsUserAuthenticated) Or IsBlank(User),
          Navigate(LoginScreen_SharePoint),
          Set(varCurrentUser, User);
          Set(varUserLeaveBalance, {
            TongNgayDuocPhep: 12,
            SoNgayDaNghi: 3,
            SoNgayConLai: 9,
            Nam: Year(Today())
          }); 
          Set(varLeaveTypes, Table(
            {MaLoai: "Annual", TenLoai: "Phép năm", CoLuong: true},
            {MaLoai: "Sick", TenLoai: "Ốm đau", CoLuong: true},
            {MaLoai: "Personal", TenLoai: "Việc cá nhân", CoLuong: false},
            {MaLoai: "Emergency", TenLoai: "Khẩn cấp", CoLuong: false}
          )); 
          Set(varSelectedLeaveType, "Annual"); 
          Set(varStartDate, Today()); 
          Set(varEndDate, Today()); 
          Set(varLeaveReason, ""); 
          Set(varHandoverPerson, ""); 
          Set(varHandoverContent, ""); 
          Set(varSessionType, "CaNgay");
          Set(varSubmissionSuccess, false); 
          Set(varIsSubmitting, false);
          Set(varFormErrors, {}))
    Children:
      - 'LeaveRequest.Header':
          Control: CanvasComponent
          ComponentName: HeaderComponent
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height * 0.065
            UserName: =If(IsBlank(User.HoTen), "Đang tải...", User.HoTen)
            UserRole: =If(IsBlank(User.MaVaiTro), "User", User.MaVaiTro)
            ShowNotification: =true
            NotificationCount: =0
            OnLogout: |
              =//Clear all session variables first
              Set(varLoginSuccess, false);
              Set(varSessionValid, false);
              Set(varLoggedInUserEmail, "");
              Set(IsUserAuthenticated, false);
              //Clear user session object
              Set(UserSession, {
                Id: "", Name: "", Email: "", Role: "", Permission: 0,
                NguoiQuanLyId: "", HoTen: "", MaVaiTro: "", 
                ChucDanh: "", MaDonVi: "", TrangThai: ""
              });
              //Clear current user and form data
              Set(varCurrentUser, Blank());
              Set(User, Blank());
              Set(varUserLeaveBalance, {});
              Set(varLeaveFormData, {});
              //Set logout flags
              Set(varLocalLoggedOut, true);
              Set(varLocalSessionCleared, true);
              //Navigate to login screen
              Navigate(LoginScreen_SharePoint)
            
      - 'LeaveRequest.Navigation':
          Control: CanvasComponent
          ComponentName: NavigationComponent
          Properties:
            X: =0
            Y: ='LeaveRequest.Header'.Height
            Width: =If(varNavCollapsed, App.Width * 0.06, App.Width * 0.2)
            Height: =Parent.Height - 'LeaveRequest.Header'.Height
            UserRole: =If(IsBlank(User.MaVaiTro), "Employee", User.MaVaiTro)
            ActiveScreen: =varActiveScreen
            IsCollapsed: =varNavCollapsed
            OnNavigate: |
              =Set(varActiveScreen, ScreenName);
              Switch(ScreenName,
                "Dashboard", Navigate(DashboardScreen_SharePoint),
                "LeaveRequest", Navigate(LeaveRequestScreen_SharePoint),
                "MyLeaves", Navigate(MyLeavesScreen_SharePoint),
                "Calendar", Navigate(CalendarScreen_SharePoint),
                "Management", Navigate(ManagementScreen_SharePoint)
              )
            OnToggleCollapse: |
              =Set(varNavCollapsed, !varNavCollapsed)
            
      - 'LeaveRequest.Content.Container':
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            X: ='LeaveRequest.Navigation'.Width
            Y: ='LeaveRequest.Header'.Height
            Width: =Parent.Width - 'LeaveRequest.Navigation'.Width
            Height: =Parent.Height - 'LeaveRequest.Header'.Height
          Children:
            # Content Padding Container
            - 'LeaveRequest.Content.Padded':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.02
                  Y: =Parent.Height * 0.02
                  Width: =Parent.Width * 0.96
                  Height: =Parent.Height * 0.96
                Children:
                  # Page Title
                  - 'LeaveRequest.Content.Title':
                      Control: Label
                      Properties:
                        X: =0
                        Y: =0
                        Width: =Parent.Width * 0.7
                        Height: =Parent.Height * 0.06
                        Text: ="Tạo đơn nghỉ phép mới"
                        Color: =RGBA(55, 65, 81, 1)
                        Font: =Font.'Open Sans'
                        FontWeight: =FontWeight.Bold
                        Size: =18
                        
                  # Leave Balance Info Card
                  - 'LeaveRequest.BalanceInfo.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='LeaveRequest.Content.Title'.Y + 'LeaveRequest.Content.Title'.Height + Parent.Height * 0.01
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.08
                      Children:
                        - 'LeaveRequest.BalanceInfo.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(227, 242, 253, 1)
                              BorderColor: =RGBA(187, 222, 251, 1)
                              BorderThickness: =1
                              
                        - 'LeaveRequest.BalanceInfo.Title':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.1
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.35
                              Text: ="Thông tin số ngày phép"
                              Color: =RGBA(33, 150, 243, 1)
                              Font: =Font.'Open Sans'
                              FontWeight: =FontWeight.Semibold
                              Size: =14
                              
                        - 'LeaveRequest.BalanceInfo.Details':
                            Control: Label
                            Properties:
                              X: =Parent.Width * 0.02
                              Y: ='LeaveRequest.BalanceInfo.Title'.Y + 'LeaveRequest.BalanceInfo.Title'.Height
                              Width: =Parent.Width * 0.96
                              Height: =Parent.Height * 0.45
                              Text: =Concatenate(
                                "Tổng số ngày phép:" & " " & varUserLeaveBalance.TongNgayDuocPhep & " ngày | ",
                                "Đã sử dụng:" & " " & varUserLeaveBalance.SoNgayDaNghi & " ngày | ",
                                "Còn lại:" & " " & varUserLeaveBalance.SoNgayConLai & " ngày")
                              Color: =RGBA(55, 65, 81, 1)
                              Font: =Font.'Open Sans'
                              Size: =12
                              
                  # Main Form Container
                  - 'LeaveRequest.Form.Container':
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        X: =0
                        Y: ='LeaveRequest.BalanceInfo.Container'.Y + 'LeaveRequest.BalanceInfo.Container'.Height + Parent.Height * 0.02
                        Width: =Parent.Width
                        Height: =Parent.Height * 0.81
                      Children:
                        - 'LeaveRequest.Form.Background':
                            Control: Rectangle
                            Properties:
                              X: =0
                              Y: =0
                              Width: =Parent.Width
                              Height: =Parent.Height
                              Fill: =RGBA(255, 255, 255, 1)
                              BorderColor: =RGBA(224, 224, 224, 1)
                              BorderThickness: =1
                              
                        # Employee Info Section
                        - 'LeaveRequest.Form.EmployeeInfo.Container':
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              X: =Parent.Width * 0.03
                              Y: =Parent.Height * 0.03
                              Width: =Parent.Width * 0.94
                              Height: =Parent.Height * 0.12
                            Children:
                              - 'LeaveRequest.Form.EmployeeInfo.Background':
                                  Control: Rectangle
                                  Properties:
                                    X: =0
                                    Y: =0
                                    Width: =Parent.Width
                                    Height: =Parent.Height
                                    Fill: =RGBA(248, 250, 252, 1)
                                    BorderColor: =RGBA(224, 224, 224, 1)
                                    BorderThickness: =1
                                    
                              - 'LeaveRequest.Form.EmployeeInfo.Title':
                                  Control: Label
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.05
                                    Width: =Parent.Width * 0.96
                                    Height: =Parent.Height * 0.3
                                    Text: ="Thông tin nhân viên"
                                    Color: =RGBA(55, 65, 81, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Size: =14
                                    
                              - 'LeaveRequest.Form.EmployeeInfo.Details':
                                  Control: GroupContainer
                                  Variant: ManualLayout
                                  Properties:
                                    X: =Parent.Width * 0.02
                                    Y: =Parent.Height * 0.4
                                    Width: =Parent.Width * 0.96
                                    Height: =Parent.Height * 0.55
                                  Children:
                                    - 'LeaveRequest.Form.EmployeeID.Info':
                                        Control: Label
                                        Properties:
                                          X: =0
                                          Y: =0
                                          Width: =Parent.Width * 0.3
                                          Height: =Parent.Height
                                          Text: ="Mã NV:" & " " & If(IsBlank(User.Id), "EMP001", User.Id)
                                          Color: =RGBA(55, 65, 81, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =12
                                          
                                    - 'LeaveRequest.Form.EmployeeName.Info':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.33
                                          Y: =0
                                          Width: =Parent.Width * 0.34
                                          Height: =Parent.Height
                                          Text: ="Họ tên:" & " " & If(IsBlank(User.HoTen), "Nguyễn Văn An", User.HoTen)
                                          Color: =RGBA(55, 65, 81, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =12
                                          
                                    - 'LeaveRequest.Form.Department.Info':
                                        Control: Label
                                        Properties:
                                          X: =Parent.Width * 0.67
                                          Y: =0
                                          Width: =Parent.Width * 0.33
                                          Height: =Parent.Height
                                          Text: ="Phòng ban:" & " " & "IT"
                                          Color: =RGBA(55, 65, 81, 1)
                                          Font: =Font.'Open Sans'
                                          Size: =12

            # Form Actions
            - 'LeaveRequest.Actions.Container':
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  X: =Parent.Width * 0.03
                  Y: ='LeaveRequest.Form.Container'.Y + 'LeaveRequest.Form.Container'.Height + Parent.Height * 0.02
                  Width: =Parent.Width * 0.94
                  Height: =Parent.Height * 0.08
                Children:
                  # Submit Button
                  - 'LeaveRequest.Actions.SubmitButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width - (Self.Width * 2) - Parent.Width * 0.02
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.15
                        Height: =Parent.Height * 0.7
                        Text: ="Gửi đơn"
                        Variant: ="Primary"
                        Icon: ="Check"
                        IsLoading: =varIsSubmitting
                        LoadingText: ="Đang gửi..."
                        IsDisabled: =Or(
                          IsBlank(varLeaveReason),
                          IsBlank(varSelectedLeaveType),
                          varStartDate > varEndDate,
                          varCalculatedDays > varUserLeaveBalance.SoNgayConLai
                        )
                        OnClick: |
                                    =Set(varIsSubmitting, true);
                                    Set(varNewLeaveRequest, Patch(Defaults(DonNghiPhep), {
                                      MaDon: GUID(),
                                      MaNhanVien: varCurrentUser.MaNhanVien,
                                      NgayBatDau: varStartDate,
                                      NgayKetThuc: varEndDate,
                                      SoNgayNghi: varCalculatedDays,
                                      MaLoai: varSelectedLeaveType,
                                      LyDo: varLeaveReason,
                                      NguoiBanGiao: varHandoverPerson,
                                      NoiDungBanGiao: varHandoverContent,
                                      TrangThai: "ChoDuyetCap1",
                                      BuoiNghi: varStartDate,
                                      NguoiTao: varCurrentUser.MaNhanVien,
                                      NgayTao: Now(),
                                      ThoiHanPheDuyet: DateAdd(Now(), varMinAdvanceDays),
                                      UuTien: "BinhThuong"
                                    }));
                                    Set(varSubmitResult, Patch(DonNghiPhep, Defaults(DonNghiPhep), varNewLeaveRequest));
                                    If(Not(IsError(varSubmitResult)),
                                      Set(varSubmissionSuccess, true),
                                      Set(varFormErrors, {Submit: "Có lỗi xảy ra khi gửi đơn. Vui lòng thử lại."}));
                                    Set(varIsSubmitting, false)
                        
                  # Cancel Button  
                  - 'LeaveRequest.Actions.CancelButton':
                      Control: CanvasComponent
                      ComponentName: ButtonComponent
                      Properties:
                        X: =Parent.Width - Self.Width
                        Y: =(Parent.Height - Self.Height) / 2
                        Width: =Parent.Width * 0.15
                        Height: =Parent.Height * 0.7
                        Text: ="Hủy"
                        Variant: ="Outline"
                        Icon: ="Cancel"
                        OnClick: =Navigate(DashboardScreen)
                        
      # Success Confirmation Modal
      - 'LeaveRequest.Confirmation.Overlay':
          Control: Rectangle
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height
            Fill: =RGBA(0, 0, 0, 0.5)
            Visible: =varSubmissionSuccess
            OnSelect: |
              =Set(varSubmissionSuccess, false)
            
      - 'LeaveRequest.Confirmation.Modal':
          Control: Rectangle
          Variant: ManualLayout
          Properties:
            X: =(Parent.Width - Self.Width) / 2
            Y: =(Parent.Height - Self.Height) / 2
            Width: =Parent.Width * 0.4
            Height: =Parent.Height * 0.3
            Fill: =RGBA(255, 255, 255, 1)
            BorderColor: =RGBA(200, 230, 201, 1)
            BorderThickness: =Parent.Width * 0.002
            DropShadow: =DropShadow.Bold
            Visible: =varSubmissionSuccess
          Children:
            - 'LeaveRequest.Confirmation.Icon':
                Control: Classic/Icon
                Properties:
                  X: =(Parent.Width - Self.Width) / 2
                  Y: =Parent.Height * 0.1
                  Width: =Parent.Height * 0.15
                  Height: =Parent.Height * 0.15
                  Icon: =Icon.Check
                  Color: =RGBA(76, 175, 80, 1)
                  
            - 'LeaveRequest.Confirmation.Title':
                Control: Label
                Properties:
                  X: =Parent.Width * 0.05
                  Y: ='LeaveRequest.Confirmation.Icon'.Y + 'LeaveRequest.Confirmation.Icon'.Height + Parent.Height * 0.05
                  Width: =Parent.Width * 0.9
                  Height: =Parent.Height * 0.15
                  Text: ="Gửi đơn thành công!"
                  Color: =RGBA(76, 175, 80, 1)
                  Font: =Font.'Open Sans'
                  FontWeight: =FontWeight.Bold
                  Size: =Parent.Height * 0.06
                  Align: =Align.Center
                  
            - 'LeaveRequest.Confirmation.Message':
                Control: Label
                Properties:
                  X: =Parent.Width * 0.05
                  Y: ='LeaveRequest.Confirmation.Title'.Y + 'LeaveRequest.Confirmation.Title'.Height
                  Width: =Parent.Width * 0.9
                  Height: =Parent.Height * 0.25
                  Text: ="Đơn nghỉ phép của bạn đã được gửi và đang chờ phê duyệt. Bạn sẽ nhận được thông báo qua email khi có kết quả."
                  Color: =RGBA(55, 65, 81, 1)
                  Font: =Font.'Open Sans'
                  Size: =Parent.Height * 0.04
                  Align: =Align.Center
                  
            - 'LeaveRequest.Confirmation.OKButton':
                Control: CanvasComponent
                ComponentName: ButtonComponent
                Properties:
                  X: =(Parent.Width - Self.Width) / 2
                  Y: =Parent.Height * 0.75
                  Width: =Parent.Width * 0.3
                  Height: =Parent.Height * 0.15
                  Text: ="OK"
                  Variant: ="Primary"
                  OnClick: =Set(varSubmissionSuccess, false); Navigate(MyLeavesScreen) 

      # Success Modal Overlay
      - 'LeaveRequest.Success.Overlay':
          Control: Rectangle
          Properties:
            X: =0
            Y: =0
            Width: =Parent.Width
            Height: =Parent.Height
            Fill: =RGBA(0, 0, 0, 0.5)
            Visible: =varSubmissionSuccess
            OnSelect: |
              =Set(varSubmissionSuccess, false) 
